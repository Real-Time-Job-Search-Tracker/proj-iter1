<style>
  /* GitHub-style heatmap */
  .heatmap-container-wrapper {
    width: 100%;
    overflow-x: auto;
  }

  .heatmap-wrapper {
    display: flex;
    align-items: flex-start;
    gap: 4px;
    padding: 10px 0;
  }

  .heatmap-weekdays {
    display: flex;
    flex-direction: column;
    gap: 3px;
    padding-top: 27px;
    padding-right: 4px;
    font-size: 12px;
    color: #656d76;
    line-height: 1;
    flex-shrink: 0;
  }

  .weekday-label {
    height: 11px;
    display: flex;
    align-items: center;
    margin: 0;
    padding: 0;
  }

  .heatmap-content {
    display: flex;
    flex-direction: column;
    gap: 0;
    flex: 1;
    min-width: 0;
  }

  .heatmap-months {
    display: flex;
    height: 17px;
    position: relative;
    margin-bottom: 4px;
  }

  .month-label {
    font-size: 12px;
    color: #656d76;
    position: absolute;
    top: 0;
    white-space: nowrap;
  }

  .heatmap-grid {
    display: flex;
    gap: 3px;
  }

  .heatmap-week {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .day-cell {
    width: 11px;
    height: 11px;
    border-radius: 2px;
    background-color: #ebedf0;
    box-sizing: border-box;
    border: 1px solid rgba(27, 31, 35, 0.06);
    cursor: pointer;
    transition: all 0.1s ease;
  }

  .day-cell:hover {
    border-color: rgba(27, 31, 35, 0.2);
    transform: scale(1.2);
  }

  .day-cell.level-0 { background-color: #ebedf0; }
  .day-cell.level-1 { background-color: #9be9a8; }
  .day-cell.level-2 { background-color: #40c463; }
  .day-cell.level-3 { background-color: #30a14e; }
  .day-cell.level-4 { background-color: #216e39; }

  .heatmap-legend {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
    margin-top: 8px;
    font-size: 11px;
    color: #656d76;
  }

  .heatmap-year-selector {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .heatmap-year-selector select {
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    color: #374151;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
  }

  /* Editable table cells */
  .editable-cell {
    position: relative;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
  }

  .editable-cell:hover {
    background-color: #f3f4f6;
  }

  .editable-cell:hover .edit-icon-btn {
    opacity: 1;
    visibility: visible;
  }

  .editable-cell.editing {
    padding: 4px 8px;
  }

  .edit-icon-btn {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    font-size: 11px;
    color: #6b7280;
    z-index: 10;
  }

  .edit-icon-btn:hover {
    background: #f3f4f6;
    border-color: #6366f1;
    color: #6366f1;
  }

  .editable-cell input,
  .editable-cell select {
    width: 100%;
    padding: 4px 8px;
    border: 1px solid #6366f1;
    border-radius: 4px;
    font-size: 14px;
    background: #ffffff;
    outline: none;
  }

  .editable-cell input:focus,
  .editable-cell select:focus {
    border-color: #4f46e5;
    box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
  }

  .charts-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    width: 100%;
    box-sizing: border-box;
  }

  .chart-card {
    min-height: 280px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    background: #fff;
    border-radius: 12px;
    box-sizing: border-box;
  }

  .chart-card h2 {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 1.5rem;
    color: #24292f;
  }

  .view-toggle-btn {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    color: #6b7280;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .view-toggle-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }

  .view-toggle-btn.active {
    background: linear-gradient(135deg, #4f46e5, #6366f1);
    color: #ffffff;
    border-color: transparent;
  }

  .view-container {
    margin-top: 1rem;
  }

  .status-filter {
    height: 32px;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    color: #6b7280;
    font-size: 12px;
    cursor: pointer;
  }

  .status-filter:focus {
    outline: none;
    border-color: #6366f1;
  }

  #countLabel {
    font-size: 12px;
    color: #6b7280;
    white-space: nowrap;
  }

  .edit-all-btn {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    color: #6b7280;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    gap: 4px;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .edit-all-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    color: #374151;
  }

  .edit-all-btn .edit-icon {
    font-size: 12px;
    opacity: 0.8;
  }

  @media (max-width: 900px) {
    .charts-row {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
  }

  /* Responsive table and chart styles */
  @media (max-width: 768px) {
    .panel-header {
      flex-direction: column;
      align-items: flex-start !important;
      gap: 1rem;
    }

    .panel-header > div:first-child {
      width: 100%;
    }

    .panel-header > div:last-child {
      width: 100%;
      flex-wrap: wrap;
      justify-content: flex-start;
    }

    .table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    #apps-table {
      min-width: 600px;
    }

    .row-actions {
      flex-direction: column;
      gap: 0.5rem;
      align-items: stretch;
    }

    .status-select {
      width: 100%;
      min-width: auto;
    }

    .board-container {
      flex-direction: column;
      overflow-x: visible;
    }

    .board-column {
      min-width: 100% !important;
      width: 100%;
    }

    .view-toggle-btn {
      font-size: 12px;
      padding: 6px 12px;
    }

    .edit-all-btn {
      width: 100%;
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    .panel-header > div:last-child {
      flex-direction: column;
    }

    .status-filter,
    .view-toggle-btn {
      width: 100%;
    }

    #paginationBar {
      flex-direction: column;
      gap: 0.75rem;
      align-items: flex-start;
    }

    #paginationBar > div {
      width: 100%;
      justify-content: space-between;
    }
  }
</style>

<h1>Dashboard</h1>

<div class="brand-strip">
  <div class="brand-strip-inner">
    <div class="brand-strip-left">
      <span class="brand-strip-title">Land your dream job</span>
      <span class="brand-strip-divider"></span>
    </div>

    <div class="brand-strip-scroller">
      <div class="logo-slider">
        <div class="logo-track">
          <% logos = %w[
            Google Amazon Meta Microsoft Apple OpenAI Netflix NVIDIA Tesla IBM
            Oracle Salesforce Adobe Intel Uber Airbnb Spotify LinkedIn ByteDance Huawei
          ] %>

          <% 2.times do %>
            <% logos.each do |logo| %>
              <span class="brand-logo"><%= logo %></span>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">

  <div class="card app-add-card">
    <div class="panel-header">
      <h2 class="app-form-title">Add an application</h2>
    </div>

    <%= form_with url: applications_path,
                  method: :post,
                  id: "new_application",
                  data: { turbo: false },
                  html: { class: "app-form-inline" } do %>

      <div class="fld url">
        <label for="application_url">
          Final apply URL <span class="app-label-hint">(Paste a job URL)</span>
        </label>
        <%= text_field_tag "application[url]",
              "",
              id: "application_url",
              type: "url",
              placeholder: "Paste a job URL (Lever/Greenhouse/‚Ä¶)",
              class: "app-input" %>
      </div>

      <div class="fld status">
        <label for="application_status">Status</label>
        <%= select_tag "application[status]",
              options_for_select(
                %w[Applied Round1 Round2 Interview Offer Accepted Declined Ghosted],
                "Applied"
              ),
              id: "application_status",
              class: "app-input" %>
      </div>

      <div class="fld company">
        <label for="application_company">
          Company <span class="app-label-hint">(optional)</span>
        </label>
        <%= text_field_tag "application[company]",
              "",
              id: "application_company",
              class: "app-input-sm" %>
      </div>

      <div class="fld title">
        <label for="application_title">
          Title <span class="app-label-hint">(optional)</span>
        </label>

        <%= text_field_tag "application[title]",
              (current_user&.default_job_title || ""),
              id: "application_title",
              class: "app-input-sm",
              list: "title_suggestions" %>

        <% cs_titles = [
            "Software Engineer",
            "Backend Engineer",
            "Frontend Engineer",
            "Fullstack Engineer",
            "Machine Learning Engineer",
            "Data Scientist"
          ] %>

        <% ds_titles = [
            "Data Scientist",
            "Data Analyst",
            "Machine Learning Engineer",
            "Business Intelligence Analyst",
            "Quant Researcher"
          ] %>

        <% ba_titles = [
            "Business Analyst",
            "Product Analyst",
            "Data Analyst",
            "Operations Analyst"
          ] %>

        <% default_titles = User::JOB_TITLES %>

        <% track = current_user&.student_track %>

        <% suggested_titles =
            case track
            when "Computer Science", "Software Engineering", "Computer Science / CS"
              cs_titles
            when "Data Science", "Data Science / DS"
              ds_titles
            when "Business Analytics", "BA / Business Analytics"
              ba_titles
            else
              default_titles
            end %>

        <datalist id="title_suggestions">
          <% suggested_titles.each do |t| %>
            <option value="<%= t %>"></option>
          <% end %>
        </datalist>
      </div>

      <%= submit_tag "Add Application", class: "btn small-add" %>

    <% end %>

    <div class="msg" id="msg"></div>
  </div>

  <!-- Êñ∞Âä†Ôºö‰∏äÈù¢ÁöÑ‰∏§‰∏™ÂõæÔºàheatmap + status donutÔºâ -->
  <div class="charts-row">
    <div class="card chart-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <h2 style="margin:0;">Application Activity</h2>
        <div class="heatmap-year-selector">
          <select id="heatmap-year-select">
            <% current_year = Date.today.year %>
            <% (current_year - 2).upto(current_year) do |year| %>
              <option value="<%= year %>" <%= 'selected' if year == current_year %>><%= year %></option>
            <% end %>
          </select>
        </div>
      </div>
      <div class="heatmap-container-wrapper">
        <div id="heatmap-container"></div>
      </div>
    </div>

    <div class="card chart-card">
      <h2>Status Distribution</h2>
      <div id="status-donut" style="width: 100%; height: 100%; min-height: 280px;"></div>
    </div>
  </div>

  <div class="section card">
    <h2>Funnel (Sankey)</h2>
    <div id="sankey"></div>
  </div>

  <!-- Applications ‰∏ªÂùóÔºöÁî®ÈòüÂëòÊñ∞ÁöÑ manage + ‰Ω†ÁöÑ Edit + Table/Chart -->
  <div class="section card">
    <div class="panel-header" style="display:flex;justify-content:space-between;align-items:center;padding-bottom:1rem;border-bottom:1px solid #e5e7eb;margin-bottom:1rem;">
      <div style="display:flex;align-items:center;gap:12px;">
        <h2 style="margin:0">Applications</h2>
        <button id="edit-all-btn" type="button" class="edit-all-btn">
          <span class="edit-icon">‚úèÔ∏è</span>
          <span class="edit-text">Edit</span>
        </button>
      </div>

      <div style="display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap;">
        <span id="countLabel" class="muted"></span>

        <select id="statusFilter" class="status-filter">
          <option value="">All statuses</option>
          <option value="Applied">Applied</option>
          <option value="Round1">Round1</option>
          <option value="Round2">Round2</option>
          <option value="Interview">Interview</option>
          <option value="Offer">Offer</option>
          <option value="Accepted">Accepted</option>
          <option value="Declined">Declined</option>
          <option value="Ghosted">Ghosted</option>
        </select>

        <select id="monthFilter" class="status-filter">
          <option value="">All months</option>
        </select>

        <button id="view-table-btn"
                type="button"
                class="view-toggle-btn active">
          Table
        </button>
        <button id="view-chart-btn"
                type="button"
                class="view-toggle-btn">
          Chart
        </button>
      </div>
    </div>


    <div id="table-view" class="view-container">
      <ul id="applications" style="display:none;">
        <% JobApplication.order(created_at: :desc).each do |app| %>
          <li data-company="<%= app.company %>">
            <span class="company"><%= app.company %></span>
            <span class="stage"><%= app.status %></span>
          </li>
        <% end %>
      </ul>

      <div id="bulkDeleteBar"
           style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:0.5rem;">
        <button
          type="button"
          id="bulkDeleteBtn"
          class="row-delete-btn">
          Delete selected
        </button>
      </div>

      <div id="apps-wrapper" style="visibility:hidden;">
        <div class="table-wrap" style="margin-top:0.5rem">
          <table id="apps-table">
            <thead>
              <tr>
                <th id="manageHeader" style="width:32px;display:none;"></th>
                <th>Applied on</th>
                <th>Company</th>
                <th>Title</th>
                <th>Status</th>
                <th>Job posting</th>
              </tr>
            </thead>
            <tbody id="apps-body"></tbody>
          </table>
        </div>

        <div id="paginationBar"
             style="display:flex;justify-content:space-between;align-items:center;margin-top:0.75rem;">
          <span id="pageInfo" class="muted"></span>
          <div style="display:flex;align-items:center;gap:0.5rem;">
            <span class="muted" style="font-size:0.85rem;">Rows per page</span>
            <select id="pageSize" class="status-filter">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
              <option value="0">All</option>
            </select>
            <button type="button" id="prevPage" class="btn small-add" style="padding-inline:0.75rem;">
              ‚Äπ
            </button>
            <button type="button" id="nextPage" class="btn small-add" style="padding-inline:0.75rem;">
              ‚Ä∫
            </button>
          </div>
        </div>
      </div>

      <!-- Notion-style board view embedded in table -->
      <div id="chart-view" class="view-container" style="display:none;margin-top:1.5rem;">
        <div id="applications-chart" style="width: 100%; min-height: 400px;"></div>
      </div>
    </div>
  </div>
</div>

<script>
  window.FAKE_JOBS   = <%= raw((@jobs || []).to_json) %>;
  window.SANKEY_DATA = <%= raw((@sankey_data || {}).to_json) %>;
  window.STATUS_DATA = <%= raw((@status_data || {}).to_json) %>;
  window.HEATMAP_DATA = <%= raw((@heatmap_data || {}).to_json) %>;

  let allApplications = [];
  let filteredApplications = [];
  let currentStatusFilter = "";
  let currentMonthFilter = "";
  let managingState = false;
  let pageSize = 20;
  let currentPage = 1;

  document.addEventListener("DOMContentLoaded", () => {
    const statusFilter   = document.getElementById("statusFilter");
    const monthFilter    = document.getElementById("monthFilter");
    const pageSizeSelect = document.getElementById("pageSize");
    const prevPageBtn    = document.getElementById("prevPage");
    const nextPageBtn    = document.getElementById("nextPage");
    const bulkDeleteBtn  = document.getElementById("bulkDeleteBtn");
    const editBtn        = document.getElementById("edit-all-btn");
    const tableBtn       = document.getElementById("view-table-btn");
    const chartBtn       = document.getElementById("view-chart-btn");

    const urlInput     = document.getElementById("application_url");
    const companyInput = document.getElementById("application_company");
    const titleInput   = document.getElementById("application_title");
    const msgEl        = document.getElementById("msg");

    if (urlInput && companyInput && titleInput) {
      let urlTimer = null;
      const runInspect = () => {
        const url = (urlInput.value || "").trim();
        if (!url) return;
        if (msgEl) msgEl.textContent = "Looking up job details‚Ä¶";

        fetch(`/jobs/inspect?url=${encodeURIComponent(url)}`, {
          headers: { Accept: "application/json" }
        })
          .then((r) => {
            if (!r.ok) throw r;
            return r.json();
          })
          .then((data) => {
            if (data.company && !companyInput.value) {
              companyInput.value = data.company;
            }
            if (data.title && !titleInput.value) {
              titleInput.value = data.title;
            }
            if (msgEl) msgEl.textContent = "";
          })
          .catch(() => {
            if (msgEl) msgEl.textContent = "";
          });
      };

      urlInput.addEventListener("blur", runInspect);
      urlInput.addEventListener("paste", () => {
        if (urlTimer) clearTimeout(urlTimer);
        urlTimer = setTimeout(runInspect, 150);
      });
      urlInput.addEventListener("keydown", () => {
        if (urlTimer) clearTimeout(urlTimer);
      });
    }

    if (statusFilter) {
      statusFilter.addEventListener("change", () => {
        currentStatusFilter = statusFilter.value;
        currentPage = 1;
        renderApplicationsFiltered();
      });
    }

    if (monthFilter) {
      monthFilter.addEventListener("change", () => {
        currentMonthFilter = monthFilter.value;
        currentPage = 1;
        renderApplicationsFiltered();
      });
    }

    if (pageSizeSelect) {
      pageSizeSelect.addEventListener("change", () => {
        const v = parseInt(pageSizeSelect.value, 10);
        pageSize = isNaN(v) ? 20 : v;
        currentPage = 1;
        renderApplicationsFiltered();
      });
    }

    if (bulkDeleteBtn) {
      const cloned = bulkDeleteBtn.cloneNode(true);
      bulkDeleteBtn.parentNode.replaceChild(cloned, bulkDeleteBtn);
      cloned.addEventListener("click", handleBulkDelete);
    }

    if (prevPageBtn) {
      prevPageBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage -= 1;
          renderApplicationsPage();
        }
      });
    }

    if (nextPageBtn) {
      nextPageBtn.addEventListener("click", () => {
        const total = filteredApplications.length;
        const effectiveSize = pageSize && pageSize > 0 ? pageSize : total || 1;
        const totalPages = Math.max(1, Math.ceil(total / effectiveSize));
        if (currentPage < totalPages) {
          currentPage += 1;
          renderApplicationsPage();
        }
      });
    }

    if (editBtn) {
      editBtn.addEventListener("click", () => {
        managingState = !managingState;
        updateManageUI();
        renderApplicationsFiltered();
      });
    }

    if (tableBtn && chartBtn) {
      tableBtn.addEventListener("click", () => switchView("table"));
      chartBtn.addEventListener("click", () => switchView("chart"));
    }

    renderStatusDonut();
    
    const yearSelect = document.getElementById("heatmap-year-select");
    if (yearSelect) {
      yearSelect.addEventListener("change", (e) => {
        renderGitHubHeatmap(parseInt(e.target.value));
      });
    }
    
    renderGitHubHeatmap(new Date().getFullYear());
    reloadApplications();
  });

  function switchView(view) {
    const tableView = document.getElementById("table-view");
    const chartView = document.getElementById("chart-view");
    const appsWrapper = document.getElementById("apps-wrapper");
    const tableBtn = document.getElementById("view-table-btn");
    const chartBtn = document.getElementById("view-chart-btn");

    if (!tableView || !chartView || !tableBtn || !chartBtn) return;

    if (view === "table") {
      if (appsWrapper) appsWrapper.style.display = "block";
      chartView.style.display = "none";
      tableBtn.classList.add("active");
      chartBtn.classList.remove("active");
    } else {
      if (appsWrapper) appsWrapper.style.display = "none";
      chartView.style.display = "block";
      chartBtn.classList.add("active");
      tableBtn.classList.remove("active");
      managingState = false;
      updateManageUI();
      renderApplicationsChart();
    }
  }

  function extractDate(app) {
    if (app.applied_on) return app.applied_on;
    if (app.created_at) return app.created_at.slice(0, 10);
    return "";
  }

  function extractMonth(app) {
    const d = extractDate(app);
    return d ? d.slice(0, 7) : "";
  }

  function reloadApplications() {
    fetch("/applications.json", { headers: { Accept: "application/json" } })
      .then((r) => {
        if (!r.ok) throw r;
        return r.json();
      })
      .then((rows) => {
        allApplications = Array.isArray(rows) ? rows : (rows.applications || []);
        currentPage = 1;
        populateMonthFilter();
        renderApplicationsFiltered();
        if (document.getElementById("applications-chart")) {
          renderApplicationsChart();
        }
      })
      .catch((e) => console.error("Failed to load applications", e));
  }

  function populateMonthFilter() {
    const monthFilter = document.getElementById("monthFilter");
    if (!monthFilter) return;

    const prev = monthFilter.value;
    const monthsSet = new Set();

    allApplications.forEach((app) => {
      const m = extractMonth(app);
      if (m) monthsSet.add(m);
    });

    const months = Array.from(monthsSet).sort();
    monthFilter.innerHTML = '<option value="">All months</option>';
    months.forEach((m) => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      monthFilter.appendChild(opt);
    });

    if (prev && months.includes(prev)) {
      monthFilter.value = prev;
      currentMonthFilter = prev;
    } else {
      currentMonthFilter = "";
    }
  }

  function renderApplicationsFiltered() {
    let rows = allApplications;

    if (currentStatusFilter) {
      const target = currentStatusFilter.toLowerCase();
      rows = rows.filter(
        (app) => (app.status || "").toLowerCase() === target
      );
    }

    if (currentMonthFilter) {
      rows = rows.filter(
        (app) => extractMonth(app) === currentMonthFilter
      );
    }

    filteredApplications = rows;
    renderApplicationsPage();
  }

  function renderApplicationsPage() {
    const total = filteredApplications.length;
    const countLabel = document.getElementById("countLabel");
    const pageInfo = document.getElementById("pageInfo");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const appsWrapper = document.getElementById("apps-wrapper");

    if (countLabel) {
      countLabel.textContent = total === 1 ? "1 item" : `${total} items`;
    }

    if (!total) {
      renderApplications([]);
      if (pageInfo) pageInfo.textContent = "";
      if (prevPageBtn) prevPageBtn.disabled = true;
      if (nextPageBtn) nextPageBtn.disabled = true;
      if (appsWrapper) appsWrapper.style.visibility = "visible";
      return;
    }


    const effectiveSize = pageSize && pageSize > 0 ? pageSize : total;
    const totalPages = Math.max(1, Math.ceil(total / effectiveSize));

    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * effectiveSize;
    const end = start + effectiveSize;
    const pageRows =
      pageSize && pageSize > 0
        ? filteredApplications.slice(start, end)
        : filteredApplications.slice();

    renderApplications(pageRows);

    if (appsWrapper) {
      appsWrapper.style.visibility = "visible";
    }


    if (pageInfo) {
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    }
    if (prevPageBtn) prevPageBtn.disabled = currentPage <= 1;
    if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
  }

  function renderApplications(rows) {
    const tbody        = document.getElementById("apps-body");
    const table        = document.getElementById("apps-table");
    const manageHeader = document.getElementById("manageHeader");

    if (!tbody) return;

    tbody.innerHTML = "";

    if (manageHeader) {
      manageHeader.style.display = managingState ? "" : "none";
    }
    if (table) {
      table.dataset.managing = managingState ? "1" : "0";
    }

      if (!rows.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = managingState ? 6 : 5;
      td.className = "muted";
      td.textContent = "No applications yet";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    rows.forEach((app) => {
      const tr = document.createElement("tr");

      if (managingState) {
        const tdSelect = document.createElement("td");
        tdSelect.style.textAlign = "center";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "row-select";
        cb.dataset.id = app.id;
        tdSelect.appendChild(cb);
        tr.appendChild(tdSelect);
      }

      const statusText = app.status || "Applied";

      // Applied on - editable
      const tdDate = document.createElement("td");
      tdDate.className = "editable-cell";
      const d = extractDate(app);
      const dateText = document.createTextNode(d || "‚Äî");
      tdDate.appendChild(dateText);
      tdDate.dataset.field = "applied_on";
      tdDate.dataset.id = app.id;
      tdDate.dataset.value = d || "";
      addEditIcon(tdDate, makeEditable);
      tr.appendChild(tdDate);

      // Company - editable
      const tdCompany = document.createElement("td");
      tdCompany.className = "editable-cell";
      tdCompany.textContent = app.company || "(unknown company)";
      tdCompany.dataset.field = "company";
      tdCompany.dataset.id = app.id;
      tdCompany.dataset.value = app.company || "";
      addEditIcon(tdCompany, makeEditable);
      tr.appendChild(tdCompany);

      // Title - editable
      const tdTitle = document.createElement("td");
      tdTitle.className = "editable-cell";
      tdTitle.textContent = app.title || "‚Äî";
      tdTitle.dataset.field = "title";
      tdTitle.dataset.id = app.id;
      tdTitle.dataset.value = app.title || "";
      addEditIcon(tdTitle, makeEditable);
      tr.appendChild(tdTitle);

      // Status - editable dropdown
      const tdStatus = document.createElement("td");
      tdStatus.className = "editable-cell";
      const statusSpan = document.createElement("span");
      statusSpan.className = "status-pill " + statusClass(statusText);
      statusSpan.textContent = statusText;
      tdStatus.appendChild(statusSpan);
      tdStatus.dataset.field = "status";
      tdStatus.dataset.id = app.id;
      tdStatus.dataset.value = statusText;
      addEditIcon(tdStatus, makeEditableSelect);
      tr.appendChild(tdStatus);

      // Job posting URL - clickable and editable
      const tdLink = document.createElement("td");
      tdLink.className = "editable-cell";
      tdLink.dataset.field = "url";
      tdLink.dataset.id = app.id;
      tdLink.dataset.value = app.url || "";
      
      if (app.url) {
        // Shorten URL for display
        const urlDisplay = shortenUrl(app.url);
        const urlSpan = document.createElement("span");
        urlSpan.style.color = "#6366f1";
        urlSpan.style.cursor = "pointer";
        urlSpan.style.textDecoration = "underline";
        urlSpan.textContent = urlDisplay;
        urlSpan.title = app.url;
        
        // Click to open
        urlSpan.addEventListener("click", (e) => {
          e.stopPropagation();
          window.open(app.url, "_blank", "noopener,noreferrer");
        });
        
        tdLink.appendChild(urlSpan);
        addEditIcon(tdLink, makeEditableUrl);
      } else {
        tdLink.textContent = "‚Äî";
        addEditIcon(tdLink, makeEditable);
      }
      
      tr.appendChild(tdLink);

      tbody.appendChild(tr);
    });

    toggleManageCheckboxVisibility();
  }

  function statusClass(status) {
    const s = (status || "").toLowerCase();
    if (s.includes("offer")) return "status-offer";
    if (s.includes("declin") || s.includes("reject")) return "status-declined";
    if (s.includes("ghost")) return "status-ghosted";
    if (s.includes("interview") || s.startsWith("round")) return "status-interview";
    return "status-applied";
  }

  function updateManageUI() {
    const bulkBar      = document.getElementById("bulkDeleteBar");
    const manageHeader = document.getElementById("manageHeader");
    const editBtn      = document.getElementById("edit-all-btn");

    if (bulkBar)      bulkBar.style.display      = managingState ? "flex" : "none";
    if (manageHeader) manageHeader.style.display = managingState ? "" : "none";

    if (!managingState) {
      document.querySelectorAll(".row-select").forEach((cb) => {
        cb.checked = false;
      });
    }

    if (editBtn) {
      if (managingState) {
        editBtn.innerHTML =
          '<span class="edit-icon">‚úî</span><span class="edit-text">Done</span>';
      } else {
        editBtn.innerHTML =
          '<span class="edit-icon">‚úèÔ∏è</span><span class="edit-text">Edit</span>';
      }
    }

    toggleManageCheckboxVisibility();
  }

  function toggleManageCheckboxVisibility() {
    const checkboxes = document.querySelectorAll(".row-select");
    checkboxes.forEach((cb) => {
      cb.style.display = managingState ? "" : "none";
      if (!managingState) cb.checked = false;
    });
  }

  function makeEditable(e, cell) {
    if (!cell) cell = e.currentTarget;
    if (cell.classList.contains("editing")) return;
    
    const field = cell.dataset.field;
    const id = cell.dataset.id;
    const currentValue = cell.dataset.value || "";
    
    cell.classList.add("editing");
    const input = document.createElement("input");
    input.type = field === "applied_on" ? "date" : "text";
    input.value = currentValue;
    input.style.width = "100%";
    
    const originalHTML = cell.innerHTML;
    const originalText = cell.textContent.replace("‚úèÔ∏è", "").trim();
    cell.innerHTML = "";
    cell.appendChild(input);
    input.focus();
    input.select();
    
    const save = () => {
      const newValue = input.value.trim();
      if (newValue !== currentValue) {
        updateApplicationField(id, field, newValue, cell);
      } else {
        cell.classList.remove("editing");
        cell.innerHTML = originalHTML;
      }
    };
    
    const cancel = () => {
      cell.classList.remove("editing");
      cell.innerHTML = originalHTML;
    };
    
    input.addEventListener("blur", save);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        input.blur();
      } else if (e.key === "Escape") {
        e.preventDefault();
        cancel();
      }
    });
  }

  function makeEditableSelect(e, cell) {
    if (!cell) cell = e.currentTarget;
    if (cell.classList.contains("editing")) return;
    
    const field = cell.dataset.field;
    const id = cell.dataset.id;
    const currentValue = cell.dataset.value || "";
    
    cell.classList.add("editing");
    const select = document.createElement("select");
    select.style.width = "100%";
    
    const options = [
      "Applied",
      "Round1",
      "Round2",
      "Interview",
      "Offer",
      "Accepted",
      "Declined",
      "Ghosted",
    ];
    
    options.forEach((opt) => {
      const o = document.createElement("option");
      o.value = opt;
      o.textContent = opt;
      if (opt === currentValue) o.selected = true;
      select.appendChild(o);
    });
    
    const originalHTML = cell.innerHTML;
    cell.innerHTML = "";
    cell.appendChild(select);
    select.focus();
    
    const save = () => {
      const newValue = select.value;
      if (newValue !== currentValue) {
        updateApplicationField(id, field, newValue, cell);
      } else {
        cell.classList.remove("editing");
        cell.innerHTML = originalHTML;
      }
    };
    
    select.addEventListener("change", save);
    select.addEventListener("blur", save);
  }

  function makeEditableUrl(e, cell) {
    if (e) e.stopPropagation();
    if (!cell) cell = e ? e.currentTarget : null;
    if (!cell || cell.classList.contains("editing")) return;
    
    const field = cell.dataset.field;
    const id = cell.dataset.id;
    const currentValue = cell.dataset.value || "";
    
    cell.classList.add("editing");
    const input = document.createElement("input");
    input.type = "url";
    input.value = currentValue;
    input.style.width = "100%";
    input.placeholder = "Enter job URL";
    
    const originalHTML = cell.innerHTML;
    cell.innerHTML = "";
    cell.appendChild(input);
    input.focus();
    input.select();
    
    const save = () => {
      const newValue = input.value.trim();
      if (newValue !== currentValue) {
        updateApplicationField(id, field, newValue, cell);
      } else {
        cell.classList.remove("editing");
        cell.innerHTML = originalHTML;
      }
    };
    
    const cancel = () => {
      cell.classList.remove("editing");
      cell.innerHTML = originalHTML;
    };
    
    input.addEventListener("blur", save);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        input.blur();
      } else if (e.key === "Escape") {
        e.preventDefault();
        cancel();
      }
    });
  }

  function shortenUrl(url) {
    if (!url) return "‚Äî";
    try {
      const urlObj = new URL(url);
      const hostname = urlObj.hostname.replace("www.", "");
      
      // Show only hostname, max 30 characters
      if (hostname.length > 30) {
        return hostname.substring(0, 27) + "...";
      }
      return hostname;
    } catch (e) {
      // If URL parsing fails, just truncate the string to 30 chars
      return url.length > 30 ? url.substring(0, 27) + "..." : url;
    }
  }

  function addEditIcon(cell, editHandler) {
    const editBtn = document.createElement("button");
    editBtn.className = "edit-icon-btn";
    editBtn.innerHTML = "‚úèÔ∏è";
    editBtn.type = "button";
    editBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      editHandler(e, cell);
    });
    cell.appendChild(editBtn);
  }

  function updateApplicationField(id, field, value, cellElement) {
    if (!id) return;
    
    const payload = {};
    payload[field] = value;
    
    fetch(`/applications/${id}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify(payload),
    })
      .then((r) => {
        if (!r.ok && r.status !== 204) throw r;
        return r.json();
      })
      .then((data) => {
        cellElement.classList.remove("editing");
        cellElement.dataset.value = value;
        
        if (field === "status") {
          const statusSpan = document.createElement("span");
          statusSpan.className = "status-pill " + statusClass(value);
          statusSpan.textContent = value;
          cellElement.innerHTML = "";
          cellElement.appendChild(statusSpan);
        } else if (field === "applied_on") {
          cellElement.textContent = value || "‚Äî";
        } else if (field === "url") {
          // Update URL display
          if (value) {
            const urlDisplay = shortenUrl(value);
            const urlSpan = document.createElement("span");
            urlSpan.style.color = "#6366f1";
            urlSpan.style.cursor = "pointer";
            urlSpan.style.textDecoration = "underline";
            urlSpan.textContent = urlDisplay;
            urlSpan.title = value;
            
            urlSpan.addEventListener("click", (e) => {
              e.stopPropagation();
              window.open(value, "_blank", "noopener,noreferrer");
            });
            
            cellElement.innerHTML = "";
            cellElement.appendChild(urlSpan);
            addEditIcon(cellElement, makeEditableUrl);
          } else {
            cellElement.textContent = "‚Äî";
            addEditIcon(cellElement, makeEditable);
          }
        } else {
          cellElement.textContent = value || (field === "company" ? "(unknown company)" : "‚Äî");
        }
        
        reloadApplications();
      })
      .catch((e) => {
        console.error("Update failed", e);
        cellElement.classList.remove("editing");
        alert("Failed to update. Please try again.");
      });
  }

  function handleBulkDelete() {
    const selected = Array.from(
      document.querySelectorAll(".row-select")
    ).filter((cb) => cb.checked && cb.dataset.id);

    if (!selected.length) {
      return;
    }

    const ids = selected.map((cb) => cb.dataset.id);

    Promise.all(
      ids.map((id) =>
        fetch(`/applications/${id}`, {
          method: "DELETE",
          headers: { Accept: "application/json" },
        }).then((r) => {
          if (!r.ok && r.status !== 204) {
            throw new Error(`Delete failed for ${id}`);
          }
        })
      )
    )
      .then(() => {
        managingState = false;
        updateManageUI();
        reloadApplications();
      })
      .catch((e) => {
        console.error("Bulk delete failed", e);
        alert("Bulk delete failed (see console for details)");
      });
  }

  function deleteApplication(id) {
    if (!id) return;
    fetch(`/applications/${id}`, {
      method: "DELETE",
      headers: { Accept: "application/json" }
    })
      .then((r) => {
        if (!r.ok && r.status !== 204) throw r;
        reloadApplications();
      })
      .catch((e) => {
        console.error("Bulk delete failed", e);
        alert("Bulk delete failed (see console for details)");
      });
  }

  function renderApplicationsChart() {
    const container = document.getElementById("applications-chart");
    if (!container) return;

    const apps = (allApplications && allApplications.length > 0)
      ? allApplications
      : (window.FAKE_JOBS || []);

    if (!apps.length) {
      container.innerHTML =
        "<div class='muted' style='text-align:center; padding-top:150px;'>No applications to display</div>";
      return;
    }

    const statusGroups = {
      "Applied": [],
      "Round1": [],
      "Round2": [],
      "Interview": [],
      "Offer": [],
      "Accepted": [],
      "Declined": [],
      "Ghosted": []
    };

    apps.forEach(app => {
      const status = app.status || "Applied";
      if (statusGroups[status]) {
        statusGroups[status].push(app);
      } else {
        statusGroups["Applied"].push(app);
      }
    });

    // Filter out statuses with no applications
    const statusesWithData = Object.keys(statusGroups).filter(status => statusGroups[status].length > 0);
    
    if (statusesWithData.length === 0) {
      container.innerHTML =
        "<div class='muted' style='text-align:center; padding-top:150px;'>No applications to display</div>";
      return;
    }

    const boardHTML = `
      <div class="board-container"
           style="display:flex;gap:1rem;overflow-x:auto;padding:0.5rem;min-height:400px;">
        ${statusesWithData.map(status => {
          const statusApps = statusGroups[status];
          return `
            <div class="board-column"
                 style="background:#f9fafb;border-radius:12px;padding:1rem;min-width:280px;flex-shrink:0;min-height:200px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:2px solid #e5e7eb;">
                <span class="status-pill ${statusClass(status)}">${status}</span>
                <span style="font-size:12px;color:#6b7280;font-weight:500;">${statusApps.length}</span>
              </div>
              <div class="board-cards" style="display:flex;flex-direction:column;gap:0.75rem;">
                ${statusApps.map(app => {
                  const appliedOn = app.applied_on || (app.created_at ? app.created_at.slice(0, 10) : "‚Äî");
                  const linkDisplay = app.url
                    ? (app.url.length > 35 ? app.url.substring(0, 35) + "..." : app.url)
                    : "‚Äî";
                  return `
                    <div class="board-card"
                         style="background:white;border-radius:8px;padding:0.875rem;border:1px solid #e5e7eb;cursor:pointer;transition:all 0.2s ease;box-shadow:0 1px 2px rgba(0,0,0,0.05);"
                         onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)';this.style.transform='translateY(-2px)'"
                         onmouseout="this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)';this.style.transform='translateY(0)'"
                         onclick="window.open('${app.url || "#"}','_blank')">
                      <div style="font-weight:600;margin-bottom:0.5rem;color:#111827;font-size:14px;">
                        ${app.company || "Unknown"}
                      </div>
                      <div style="font-size:12px;color:#6b7280;margin-bottom:0.375rem;line-height:1.4;">
                        ${app.title || ""}
                      </div>
                      <div style="font-size:11px;color:#9ca3af;margin-bottom:0.5rem;">
                        ${appliedOn}
                      </div>
                      ${app.url ? `
                        <div style="font-size:11px;color:#6366f1;text-decoration:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:0.5rem;padding-top:0.5rem;border-top:1px solid #f3f4f6;"
                             title="${app.url}">
                          üîó ${linkDisplay}
                        </div>` : ""}
                    </div>
                  `;
                }).join("")}
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
    container.innerHTML = boardHTML;
  }

  function renderStatusDonut() {
    const dataObj = window.STATUS_DATA || {};
    const labels = Object.keys(dataObj);
    const values = Object.values(dataObj);

    if (!labels.length) {
      const el = document.getElementById("status-donut");
      if (el) {
        el.innerHTML =
          "<div class='muted' style='text-align:center; padding-top:80px;'>No data available</div>";
      }
      return;
    }

    const colorMap = {
      "Applied": "#3b82f6", "Round1": "#8b5cf6", "Round2": "#d946ef",
      "Interview": "#a855f7", "Offer": "#22c55e", "Accepted": "#15803d",
      "Rejected": "#ef4444", "Declined": "#f59e0b", "Ghosted": "#94a3b8"
    };
    const colors = labels.map(l => colorMap[l] || "#cbd5e1");

    const data = [{
      values: values,
      labels: labels,
      type: "pie",
      hole: 0.6,
      marker: { colors: colors },
      textinfo: "label+value",
      hoverinfo: "label+percent",
      showlegend: false
    }];

    const layout = {
      autosize: true,
      height: 280,
      margin: { t: 40, b: 50, l: 10, r: 10 },
      paper_bgcolor: "rgba(0,0,0,0)",
      font: { family: "Manrope, sans-serif", size: 14 }
    };

    if (document.getElementById("status-donut")) {
      Plotly.newPlot("status-donut", data, layout, { displayModeBar: false });
    }
  }

  function renderGitHubHeatmap(year) {
    const container = document.getElementById("heatmap-container");
    if (!container) return;

    container.innerHTML = "";

    const data = window.HEATMAP_DATA || {};
    const selectedYear = year || new Date().getFullYear();
    const today = new Date();
    
    // Start from January 1st of the selected year
    const startDate = new Date(selectedYear, 0, 1);
    // End at December 31st of the selected year, or today if current year
    const endDate = selectedYear === today.getFullYear() 
      ? today 
      : new Date(selectedYear, 11, 31);
    
    // Find the first Sunday before or on Jan 1st
    const dayOfWeek = startDate.getDay();
    const firstSunday = new Date(startDate);
    firstSunday.setDate(startDate.getDate() - dayOfWeek);

    const wrapper = document.createElement("div");
    wrapper.className = "heatmap-wrapper";

    // Weekday labels column
    const weekdaysCol = document.createElement("div");
    weekdaysCol.className = "heatmap-weekdays";
    weekdaysCol.innerHTML = `
      <div class="weekday-label"></div>
      <div class="weekday-label">Mon</div>
      <div class="weekday-label"></div>
      <div class="weekday-label">Wed</div>
      <div class="weekday-label"></div>
      <div class="weekday-label">Fri</div>
      <div class="weekday-label"></div>
    `;
    wrapper.appendChild(weekdaysCol);

    // Content column
    const contentCol = document.createElement("div");
    contentCol.className = "heatmap-content";

    // Months row
    const monthsRow = document.createElement("div");
    monthsRow.className = "heatmap-months";
    
    // Grid row
    const gridRow = document.createElement("div");
    gridRow.className = "heatmap-grid";

    let currentDate = new Date(firstSunday);
    const cellSize = 11;
    const gap = 3;
    const weekWidth = cellSize + gap;
    const monthsAdded = new Set();
    let lastMonthName = null;
    let weekIndex = 0;

    // Generate 53 weeks (full year + some overflow)
    while (weekIndex < 53) {
      const weekCol = document.createElement("div");
      weekCol.className = "heatmap-week";

      // Check the first day of the week for month label
      const weekStartDate = new Date(currentDate);
      const currentMonthName = weekStartDate.toLocaleString("default", { month: "short" });
      
      // Add month label when we encounter a new month
      if (currentMonthName !== lastMonthName && weekStartDate.getDate() <= 7) {
        if (lastMonthName !== null || weekIndex === 0) {
          const monthLabel = document.createElement("div");
          monthLabel.className = "month-label";
          monthLabel.textContent = currentMonthName;
          monthLabel.style.left = `${weekIndex * weekWidth}px`;
          monthsRow.appendChild(monthLabel);
        }
        lastMonthName = currentMonthName;
      }

      // Generate 7 days for this week
      for (let d = 0; d < 7; d++) {
        const dateStr = currentDate.toISOString().split("T")[0];
        const yearOfDate = currentDate.getFullYear();
        const count = (yearOfDate === selectedYear && data[dateStr]) ? data[dateStr] : 0;

        const cell = document.createElement("div");
        cell.className = "day-cell level-0";
        
        // Determine level based on count
        if (currentDate <= endDate && currentDate >= startDate) {
          if (count > 5) cell.classList.add("level-4");
          else if (count > 3) cell.classList.add("level-3");
          else if (count > 1) cell.classList.add("level-2");
          else if (count > 0) cell.classList.add("level-1");
        }
        
        cell.title = `${dateStr}: ${count} application${count !== 1 ? 's' : ''}`;
        weekCol.appendChild(cell);
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      gridRow.appendChild(weekCol);
      weekIndex++;
      
      // Stop if we've passed the end date
      if (currentDate > endDate && weekIndex > 1) break;
    }

    contentCol.appendChild(monthsRow);
    contentCol.appendChild(gridRow);

    // Legend
    const legend = document.createElement("div");
    legend.className = "heatmap-legend";
    legend.innerHTML = `
      <span>Less</span>
      <div class="day-cell level-0"></div>
      <div class="day-cell level-1"></div>
      <div class="day-cell level-2"></div>
      <div class="day-cell level-3"></div>
      <div class="day-cell level-4"></div>
      <span>More</span>
    `;
    contentCol.appendChild(legend);

    wrapper.appendChild(contentCol);
    container.appendChild(wrapper);
  }
</script>