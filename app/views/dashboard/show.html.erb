<h1>Dashboard</h1>

<div class="brand-strip">
  <div class="brand-strip-inner">
    <div class="brand-strip-left">
      <span class="brand-strip-title">Land your dream job</span>
      <span class="brand-strip-divider"></span>
    </div>

    <div class="brand-strip-scroller">
      <div class="logo-slider">
        <div class="logo-track">
          <% logos = %w[
            Google Amazon Meta Microsoft Apple OpenAI Netflix NVIDIA Tesla IBM
            Oracle Salesforce Adobe Intel Uber Airbnb Spotify LinkedIn ByteDance Huawei
          ] %>

          <% 2.times do %>
            <% logos.each do |logo| %>
              <span class="brand-logo"><%= logo %></span>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">

  <div class="card app-add-card">
    <div class="panel-header">
      <h2 class="app-form-title">Add an application</h2>
    </div>

    <%= form_with url: applications_path,
                  method: :post,
                  id: "new_application",
                  data: { turbo: false },
                  html: { class: "app-form-inline" } do %>

      <div class="fld url">
        <label for="application_url">
          Final apply URL <span class="app-label-hint">(Paste a job URL)</span>
        </label>
        <%= text_field_tag "application[url]",
              "",
              id: "application_url",
              type: "url",
              placeholder: "Paste a job URL (Lever/Greenhouse/…)",
              class: "app-input" %>
      </div>

      <div class="fld status">
        <label for="application_status">Status</label>
        <%= select_tag "application[status]",
              options_for_select(
                %w[Applied Round1 Round2 Interview Offer Accepted Declined Ghosted],
                "Applied"
              ),
              id: "application_status",
              class: "app-input" %>
      </div>

      <div class="fld company">
        <label for="application_company">
          Company <span class="app-label-hint">(optional)</span>
        </label>
        <%= text_field_tag "application[company]",
              "",
              id: "application_company",
              class: "app-input-sm" %>
      </div>

<div class="fld title">
  <label for="application_title">
    Title <span class="app-label-hint">(optional)</span>
  </label>

  <%= text_field_tag "application[title]",
        (current_user&.default_job_title || ""),
        id: "application_title",
        class: "app-input-sm",
        list: "title_suggestions" %>

  <% cs_titles = [
      "Software Engineer",
      "Backend Engineer",
      "Frontend Engineer",
      "Fullstack Engineer",
      "Machine Learning Engineer",
      "Data Scientist"
    ] %>

  <% ds_titles = [
      "Data Scientist",
      "Data Analyst",
      "Machine Learning Engineer",
      "Business Intelligence Analyst",
      "Quant Researcher"
    ] %>

  <% ba_titles = [
      "Business Analyst",
      "Product Analyst",
      "Data Analyst",
      "Operations Analyst"
    ] %>

  <% default_titles = User::JOB_TITLES %>

  <% track = current_user&.student_track %>

  <% suggested_titles =
      case track
      when "Computer Science", "Software Engineering", "Computer Science / CS"
        cs_titles
      when "Data Science", "Data Science / DS"
        ds_titles
      when "Business Analytics", "BA / Business Analytics"
        ba_titles
      else
        default_titles
      end %>

  <datalist id="title_suggestions">
    <% suggested_titles.each do |t| %>
      <option value="<%= t %>"></option>
    <% end %>
  </datalist>
</div>


      <%= submit_tag "Add Application", class: "btn small-add" %>

    <% end %>

    <div class="msg" id="msg"></div>
  </div>

  <div class="section card">
    <h2>Funnel (Sankey)</h2>
    <div id="sankey"></div>
  </div>

  <div class="section card">
    <div class="panel-header" style="display:flex;justify-content:space-between;align-items:center;">
      <h2 style="margin:0">Applications</h2>
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <span id="countLabel" class="muted"></span>

        <select id="statusFilter" class="status-filter">
          <option value="">All statuses</option>
          <option value="Applied">Applied</option>
          <option value="Round1">Round1</option>
          <option value="Round2">Round2</option>
          <option value="Interview">Interview</option>
          <option value="Offer">Offer</option>
          <option value="Accepted">Accepted</option>
          <option value="Declined">Declined</option>
          <option value="Ghosted">Ghosted</option>
        </select>

        <select id="monthFilter" class="status-filter">
          <option value="">All months</option>
        </select>

        <button type="button" id="manageToggle" class="btn small-add">
          Manage
        </button>
      </div>
    </div>

    <ul id="applications" style="display:none;">
      <% JobApplication.order(created_at: :desc).each do |app| %>
        <li data-company="<%= app.company %>">
          <span class="company"><%= app.company %></span>
          <span class="stage"><%= app.status %></span>
        </li>
      <% end %>
    </ul>

    <div id="bulkDeleteBar"
        style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:0.5rem;">
      <button
        type="button"
        id="bulkDeleteBtn"
        class="row-delete-btn">
        Delete selected
      </button>
    </div>

    <div class="table-wrap" style="margin-top:0.5rem">
      <table id="apps-table">
        <thead>
          <tr>
            <th id="manageHeader" style="width:32px;display:none;"></th>
            <th>Applied on</th>
            <th>Company</th>
            <th>Title</th>
            <th>Status</th>
            <th>Actions</th>
            <th>Job posting</th>
          </tr>
        </thead>
        <tbody id="apps-body"></tbody>
      </table>
    </div>

    <div id="paginationBar"
         style="display:flex;justify-content:space-between;align-items:center;margin-top:0.75rem;">
      <span id="pageInfo" class="muted"></span>
      <div style="display:flex;align-items:center;gap:0.5rem;">
        <span class="muted" style="font-size:0.85rem;">Rows per page</span>
        <select id="pageSize" class="status-filter">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="0">All</option>
        </select>
        <button type="button" id="prevPage" class="btn small-add" style="padding-inline:0.75rem;">
          ‹
        </button>
        <button type="button" id="nextPage" class="btn small-add" style="padding-inline:0.75rem;">
          ›
        </button>
      </div>
    </div>
  </div>

</div>

<script>
  window.FAKE_JOBS = <%= raw((@jobs || []).to_json) %>;

  let allApplications = [];
  let filteredApplications = [];
  let currentStatusFilter = "";
  let currentMonthFilter = "";
  let managingState = false;
  let pageSize = 20;
  let currentPage = 1;

  document.addEventListener("DOMContentLoaded", () => {
    const statusFilter   = document.getElementById("statusFilter");
    const monthFilter    = document.getElementById("monthFilter");
    const manageToggle   = document.getElementById("manageToggle");
    const pageSizeSelect = document.getElementById("pageSize");
    const prevPageBtn    = document.getElementById("prevPage");
    const nextPageBtn    = document.getElementById("nextPage");
    const bulkDeleteBtn  = document.getElementById("bulkDeleteBtn");

    if (statusFilter) {
      statusFilter.addEventListener("change", () => {
        currentStatusFilter = statusFilter.value;
        currentPage = 1;
        renderApplicationsFiltered();
      });
    }

    if (monthFilter) {
      monthFilter.addEventListener("change", () => {
        currentMonthFilter = monthFilter.value;
        currentPage = 1;
        renderApplicationsFiltered();
      });
    }

    if (pageSizeSelect) {
      pageSizeSelect.addEventListener("change", () => {
        const v = parseInt(pageSizeSelect.value, 10);
        pageSize = isNaN(v) ? 20 : v;
        currentPage = 1;
        renderApplicationsFiltered();
      });
    }

    if (manageToggle) {
      manageToggle.addEventListener("click", () => {
        managingState = !managingState;
        updateManageUI();
        renderApplicationsFiltered();
      });
    }

    if (bulkDeleteBtn) {
      const cloned = bulkDeleteBtn.cloneNode(true);
      bulkDeleteBtn.parentNode.replaceChild(cloned, bulkDeleteBtn);
      cloned.addEventListener("click", handleBulkDelete);
    }

    if (prevPageBtn) {
      prevPageBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage -= 1;
          renderApplicationsPage();
        }
      });
    }

    if (nextPageBtn) {
      nextPageBtn.addEventListener("click", () => {
        const total = filteredApplications.length;
        const effectiveSize = pageSize && pageSize > 0 ? pageSize : total || 1;
        const totalPages = Math.max(1, Math.ceil(total / effectiveSize));
        if (currentPage < totalPages) {
          currentPage += 1;
          renderApplicationsPage();
        }
      });
    }

    reloadApplications();
  });

  function extractDate(app) {
    if (app.applied_on) return app.applied_on;
    if (app.created_at) return app.created_at.slice(0, 10);
    return "";
  }

  function extractMonth(app) {
    const d = extractDate(app);
    return d ? d.slice(0, 7) : "";
  }

  function reloadApplications() {
    fetch("/applications.json", { headers: { Accept: "application/json" } })
      .then((r) => {
        if (!r.ok) throw r;
        return r.json();
      })
      .then((rows) => {
        allApplications = Array.isArray(rows) ? rows : (rows.applications || []);
        currentPage = 1;
        populateMonthFilter();
        renderApplicationsFiltered();
      })
      .catch((e) => console.error("Failed to load applications", e));
  }

  function populateMonthFilter() {
    const monthFilter = document.getElementById("monthFilter");
    if (!monthFilter) return;

    const prev = monthFilter.value;
    const monthsSet = new Set();

    allApplications.forEach((app) => {
      const m = extractMonth(app);
      if (m) monthsSet.add(m);
    });

    const months = Array.from(monthsSet).sort();
    monthFilter.innerHTML = '<option value="">All months</option>';
    months.forEach((m) => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      monthFilter.appendChild(opt);
    });

    if (prev && months.includes(prev)) {
      monthFilter.value = prev;
      currentMonthFilter = prev;
    } else {
      currentMonthFilter = "";
    }
  }

  function renderApplicationsFiltered() {
    let rows = allApplications;

    if (currentStatusFilter) {
      const target = currentStatusFilter.toLowerCase();
      rows = rows.filter(
        (app) => (app.status || "").toLowerCase() === target
      );
    }

    if (currentMonthFilter) {
      rows = rows.filter(
        (app) => extractMonth(app) === currentMonthFilter
      );
    }

    filteredApplications = rows;
    renderApplicationsPage();
  }

  function renderApplicationsPage() {
    const total = filteredApplications.length;
    const countLabel = document.getElementById("countLabel");
    const pageInfo = document.getElementById("pageInfo");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");

    if (countLabel) {
      countLabel.textContent = total === 1 ? "1 item" : `${total} items`;
    }

    if (!total) {
      renderApplications([]);
      if (pageInfo) pageInfo.textContent = "";
      if (prevPageBtn) prevPageBtn.disabled = true;
      if (nextPageBtn) nextPageBtn.disabled = true;
      return;
    }

    const effectiveSize = pageSize && pageSize > 0 ? pageSize : total;
    const totalPages = Math.max(1, Math.ceil(total / effectiveSize));

    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * effectiveSize;
    const end = start + effectiveSize;
    const pageRows =
      pageSize && pageSize > 0
        ? filteredApplications.slice(start, end)
        : filteredApplications.slice();

    renderApplications(pageRows);

    if (pageInfo) {
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    }
    if (prevPageBtn) prevPageBtn.disabled = currentPage <= 1;
    if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
  }

  function renderApplications(rows) {
    const tbody        = document.getElementById("apps-body");
    const table        = document.getElementById("apps-table");
    const manageHeader = document.getElementById("manageHeader");

    if (!tbody) return;

    tbody.innerHTML = "";

    if (manageHeader) {
      manageHeader.style.display = managingState ? "" : "none";
    }
    if (table) {
      table.dataset.managing = managingState ? "1" : "0";
    }

    if (!rows.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = managingState ? 7 : 6;
      td.className = "muted";
      td.textContent = "No applications yet";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    rows.forEach((app) => {
      const tr = document.createElement("tr");

      if (managingState) {
        const tdSelect = document.createElement("td");
        tdSelect.style.textAlign = "center";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "row-select";
        cb.dataset.id = app.id;
        tdSelect.appendChild(cb);
        tr.appendChild(tdSelect);
      }

      const statusText = app.status || "Applied";

      const tdDate = document.createElement("td");
      const d = extractDate(app);
      tdDate.textContent = d || "—";
      tr.appendChild(tdDate);

      const tdCompany = document.createElement("td");
      tdCompany.textContent = app.company || "(unknown company)";
      tr.appendChild(tdCompany);

      const tdTitle = document.createElement("td");
      tdTitle.textContent = app.title || "—";
      tr.appendChild(tdTitle);

      const tdStatus = document.createElement("td");
      const statusSpan = document.createElement("span");
      statusSpan.className = "status-pill " + statusClass(statusText);
      statusSpan.textContent = statusText;
      tdStatus.appendChild(statusSpan);
      tr.appendChild(tdStatus);

      const tdActions = document.createElement("td");
      tdActions.className = "row-actions";

      const select = document.createElement("select");
      select.className = "status-select";

      const options = [
        "Applied",
        "Round1",
        "Round2",
        "Interview",
        "Offer",
        "Accepted",
        "Declined",
        "Ghosted",
      ];
      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        if ((statusText || "").toLowerCase() === opt.toLowerCase()) {
          o.selected = true;
        }
        select.appendChild(o);
      });

      select.addEventListener("change", () => {
        updateApplicationStatus(app.id, select.value);
      });

      tdActions.appendChild(select);
      tr.appendChild(tdActions);

      const tdLink = document.createElement("td");
      if (app.url) {
        const linkBtn = document.createElement("a");
        linkBtn.href = app.url;
        linkBtn.target = "_blank";
        linkBtn.rel = "noopener noreferrer";
        linkBtn.className = "table-link-btn";
        linkBtn.textContent = "View job";
        tdLink.appendChild(linkBtn);
      } else {
        tdLink.textContent = "—";
      }
      tr.appendChild(tdLink);

      tbody.appendChild(tr);
    });

    toggleManageCheckboxVisibility();
  }

  function statusClass(status) {
    const s = (status || "").toLowerCase();
    if (s.includes("offer")) return "status-offer";
    if (s.includes("declin") || s.includes("reject")) return "status-declined";
    if (s.includes("ghost")) return "status-ghosted";
    if (s.includes("interview") || s.startsWith("round")) return "status-interview";
    return "status-applied";
  }

  function updateManageUI() {
    const bulkBar      = document.getElementById("bulkDeleteBar");
    const manageHeader = document.getElementById("manageHeader");
    const manageToggle = document.getElementById("manageToggle");

    if (bulkBar)      bulkBar.style.display      = managingState ? "flex" : "none";
    if (manageHeader) manageHeader.style.display = managingState ? "" : "none";
    if (manageToggle) manageToggle.textContent   = managingState ? "Done" : "Manage";

    if (!managingState) {
      document.querySelectorAll(".row-select").forEach((cb) => {
        cb.checked = false;
      });
    }

    toggleManageCheckboxVisibility();
  }

  function toggleManageCheckboxVisibility() {
    const checkboxes = document.querySelectorAll(".row-select");
    checkboxes.forEach((cb) => {
      cb.style.display = managingState ? "" : "none";
      if (!managingState) cb.checked = false;
    });
  }

  function updateApplicationStatus(id, status) {
    if (!id) return;
    fetch(`/applications/${id}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify({ status }),
    })
      .then((r) => {
        if (!r.ok && r.status !== 204) throw r;
        window.location.reload();
      })
      .catch((e) => console.error("Status update failed", e));
  }

  function handleBulkDelete() {
    const selected = Array.from(
      document.querySelectorAll(".row-select")
    ).filter((cb) => cb.checked && cb.dataset.id);

    console.log(
      "[bulk delete] selected:",
      selected.map((cb) => ({ id: cb.dataset.id, checked: cb.checked }))
    );

    if (!selected.length) {
      return;
    }

    const ids = selected.map((cb) => cb.dataset.id);

    Promise.all(
      ids.map((id) =>
        fetch(`/applications/${id}`, {
          method: "DELETE",
          headers: { Accept: "application/json" },
        }).then((r) => {
          if (!r.ok && r.status !== 204) {
            throw new Error(`Delete failed for ${id}`);
          }
        })
      )
    )
      .then(() => {
        managingState = false;
        updateManageUI();
        reloadApplications();
      })
      .catch((e) => {
        console.error("Bulk delete failed", e);
        alert("Bulk delete failed (see console for details)");
      });
  }

  function deleteApplication(id) {
    if (!id) return;
    fetch(`/applications/${id}`, {
      method: "DELETE",
      headers: { Accept: "application/json" }
    })
      .then((r) => {
        if (!r.ok && r.status !== 204) throw r;
        window.location.reload();
      })
      .catch((e) => {
        console.error("Bulk delete failed", e);
        alert("Bulk delete failed (see console for details)");
      });
  }
</script>
