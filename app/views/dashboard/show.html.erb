<style>
  /* --- Heatmap Styles (GitHub Style) --- */
  .heatmap-wrapper {
    display: flex;
    align-items: flex-end; /* Align weekday labels with bottom of chart */
    gap: 8px;
    width: 100%;
    overflow-x: auto;
    padding-bottom: 10px;
  }

  /* Left column: Weekday labels (Mon, Wed, Fri) */
  .heatmap-weekdays {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 88px; /* 7 cells * 10px + 6 gaps * 3px = ~88px */
    padding-top: 25px; /* Offset for month labels */
    padding-right: 5px;
    font-size: 10px;
    color: #656d76;
    line-height: 1;
  }
  
  .weekday-label {
    height: 10px; /* Match cell height */
    display: flex;
    align-items: center;
  }

  /* Main chart area */
  .heatmap-content {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  /* Top row: Month labels */
  .heatmap-months {
    display: flex;
    height: 15px;
    position: relative; /* For absolute positioning of months if needed, or flex */
  }
  
  .month-label {
    font-size: 10px;
    color: #656d76;
    position: absolute; /* We will position these via JS */
    top: 0;
  }

  /* The Grid: Flex row of "Week Columns" */
  .heatmap-grid {
    display: flex;
    gap: 3px;
  }

  /* A single column representing one week (Sun-Sat) */
  .heatmap-week {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  /* Individual Day Cell */
  .day-cell {
    width: 11px;
    height: 11px;
    border-radius: 2px;
    background-color: #ebedf0; /* GitHub empty color */
    box-sizing: border-box;
    border: 1px solid rgba(27, 31, 35, 0.06);
  }
  
  /* GitHub Color Scale */
  .day-cell.level-1 { background-color: #9be9a8; border-color: rgba(27, 31, 35, 0.06); }
  .day-cell.level-2 { background-color: #40c463; border-color: rgba(27, 31, 35, 0.06); }
  .day-cell.level-3 { background-color: #30a14e; border-color: rgba(27, 31, 35, 0.06); }
  .day-cell.level-4 { background-color: #216e39; border-color: rgba(27, 31, 35, 0.06); }

  /* Legend Styles */
  .heatmap-legend {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
    margin-top: 8px;
    font-size: 10px;
    color: #656d76;
  }

  /* --- Layout Styles (Card) --- */
  .charts-row {
    display: grid; 
    grid-template-columns: 2fr 1fr; 
    gap: 1.5rem; 
    margin-bottom: 1.5rem;
    width: 100%;
    box-sizing: border-box;
  }

  .chart-card {
    min-height: 280px; 
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    background: #fff;
    border-radius: 12px;
    box-sizing: border-box; 
  }

  .chart-card h2 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: #24292f;
  }

  @media (max-width: 900px) {
    .charts-row { 
      grid-template-columns: 1fr; 
      gap: 1rem;
    }
  }
</style>

<h1>Dashboard</h1>

<div class="brand-strip">
  <div class="brand-strip-inner">
    <div class="brand-strip-left">
      <span class="brand-strip-title">Land your dream job</span>
      <span class="brand-strip-divider"></span>
    </div>

    <div class="brand-strip-scroller">
      <div class="logo-slider">
        <div class="logo-track">
          <% logos = %w[
            Google Amazon Meta Microsoft Apple OpenAI Netflix NVIDIA Tesla IBM
            Oracle Salesforce Adobe Intel Uber Airbnb Spotify LinkedIn ByteDance Huawei
          ] %>

          <% 2.times do %>
            <% logos.each do |logo| %>
              <span class="brand-logo"><%= logo %></span>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">

  <div class="card app-add-card">
    <div class="panel-header">
      <h2 class="app-form-title">Add an application</h2>
    </div>

    <%= form_with url: applications_path,
                  method: :post,
                  id: "new_application",
                  data: { turbo: false },
                  html: { class: "app-form-inline" } do %>

      <div class="fld url">
        <label for="application_url">Final apply URL</label>
        <%= text_field_tag "application[url]", "", id: "application_url", type: "url", placeholder: "Paste a job URL...", class: "app-input" %>
      </div>

      <div class="fld date">
        <label for="application_applied_on">Applied on</label>
        <%= date_field_tag "application[applied_on]", Date.today, id: "application_applied_on", class: "app-input" %>
      </div>

      <div class="fld status">
        <label for="application_status">Status</label>
        <%= select_tag "application[status]", options_for_select(%w[Applied Round1 Round2 Interview Offer Accepted Declined Ghosted], "Applied"), id: "application_status", class: "app-input" %>
      </div>

      <div class="fld company">
        <label for="application_company">Company</label>
        <%= text_field_tag "application[company]", "", id: "application_company", class: "app-input-sm" %>
      </div>

      <div class="fld title">
        <label for="application_title">Title</label>
        <%= text_field_tag "application[title]", (current_user&.default_job_title || ""), id: "application_title", class: "app-input-sm", list: "title_suggestions" %>
        <datalist id="title_suggestions">
          <% ["Software Engineer", "Product Manager", "Data Scientist"].each do |t| %>
            <option value="<%= t %>"></option>
          <% end %>
        </datalist>
      </div>

      <%= submit_tag "Add Application", class: "btn small-add" %>
    <% end %>
    <div class="msg" id="msg"></div>
  </div>

  <div class="charts-row">
    
    <div class="card chart-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Application Activity</h2>
        <span style="font-size:0.85rem; color:#656d76;">Last 6 months</span>
      </div>
      
      <div id="heatmap-container" style="flex: 1; display: flex; align-items: center; justify-content: center; overflow-x: auto; width: 100%;">
        </div>
    </div>

    <div class="card chart-card">
      <h2>Status Distribution</h2>
      <div id="status-donut" style="width: 100%; height: 100%; min-height: 220px;"></div>
    </div>
    
  </div>

  <div class="section card">
    <h2>Funnel (Sankey)</h2>
    <div id="sankey"></div>
  </div>

  <div class="section card">
    <div class="panel-header"><h2>Applications</h2></div>
    <div class="table-wrap">
       <table id="apps-table">
         <thead>
           <tr><th>Applied on</th><th>Company</th><th>Title</th><th>Status</th><th>Actions</th></tr>
         </thead>
         <tbody id="apps-body"></tbody>
       </table>
    </div>
  </div>

</div>

<script>
  // 1. Data Injection
  window.FAKE_JOBS = <%= raw((@apps || []).to_json) %>;
  window.SANKEY_DATA = <%= raw(@sankey_data.to_json) %>;
  window.DEMO_MODE = <%= (@demo_mode || false).to_json %>;
  window.STATUS_DATA = <%= raw(@status_data.to_json) %>;
  window.HEATMAP_DATA = <%= raw(@heatmap_data.to_json) %>;

  document.addEventListener("DOMContentLoaded", () => {
    renderStatusDonut();
    renderGitHubHeatmap();
    reloadApplications(); // Your existing list loader
  });

  // --- Logic for Status Donut Chart (Plotly) ---
  function renderStatusDonut() {
    const dataObj = window.STATUS_DATA || {};
    const labels = Object.keys(dataObj);
    const values = Object.values(dataObj);

    if (labels.length === 0) {
      document.getElementById('status-donut').innerHTML = "<div class='muted' style='text-align:center; padding-top:80px;'>No data available</div>";
      return;
    }

    const colorMap = {
      "Applied": "#3b82f6", "Round1": "#8b5cf6", "Round2": "#d946ef", "Interview": "#a855f7",
      "Offer": "#22c55e", "Accepted": "#15803d", "Rejected": "#ef4444", 
      "Declined": "#f59e0b", "Ghosted": "#94a3b8"
    };
    const colors = labels.map(l => colorMap[l] || "#cbd5e1");

    const data = [{
      values: values,
      labels: labels,
      type: 'pie',
      hole: 0.6, 
      marker: { colors: colors },
      textinfo: 'label+value', 
      hoverinfo: 'label+percent',
      showlegend: false
    }];

    const layout = {
      autosize: true,
      margin: { t: 10, b: 10, l: 10, r: 10 }, 
      paper_bgcolor: "rgba(0,0,0,0)",
      font: { family: 'Manrope, sans-serif', size: 14 }
    };

    if (document.getElementById('status-donut')) {
      Plotly.newPlot('status-donut', data, layout, {displayModeBar: false});
    }
  }

  // --- Logic for GitHub-style 6 Month Heatmap ---
  function renderGitHubHeatmap() {
    const container = document.getElementById('heatmap-container');
    if (!container) return;

    const data = window.HEATMAP_DATA || {};
    
    // 1. Calculate Date Range (Last 6 Months, aligned to Sunday)
    const today = new Date();
    // Go back ~26 weeks (approx 6 months)
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - (26 * 7));
    
    // Adjust start date to the nearest preceding Sunday
    const dayOfWeek = startDate.getDay(); // 0 is Sunday
    startDate.setDate(startDate.getDate() - dayOfWeek);

    // 2. Build DOM Structure
    // Wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'heatmap-wrapper';

    // Left Column: Weekdays
    const weekdaysCol = document.createElement('div');
    weekdaysCol.className = 'heatmap-weekdays';
    // Positions match the grid: Mon(1), Wed(3), Fri(5)
    // We use spacers or specific margins. GitHub simply puts labels roughly aligned.
    weekdaysCol.innerHTML = `
      <div class="weekday-label" style="margin-top: 14px;">Mon</div>
      <div class="weekday-label" style="margin-top: 14px;">Wed</div>
      <div class="weekday-label" style="margin-top: 14px;">Fri</div>
    `;
    wrapper.appendChild(weekdaysCol);

    // Right Content: Months + Grid
    const contentCol = document.createElement('div');
    contentCol.className = 'heatmap-content';

    // Month Row
    const monthsRow = document.createElement('div');
    monthsRow.className = 'heatmap-months';
    
    // Grid Row
    const gridRow = document.createElement('div');
    gridRow.className = 'heatmap-grid';

    // 3. Generate Weeks and Days
    let currentDate = new Date(startDate);
    const monthsAdded = new Set(); // To track which months we've added labels for

    // Generate 27 columns (weeks) to cover the range fully
    for (let w = 0; w < 27; w++) {
      const weekCol = document.createElement('div');
      weekCol.className = 'heatmap-week';

      // Check month for the top label (check the first day of this week)
      const currentMonthName = currentDate.toLocaleString('default', { month: 'short' });
      // Only add label if it's a new month and we are not in the very first week (to avoid cutoff)
      if (!monthsAdded.has(currentMonthName) && w > 0) {
        monthsAdded.add(currentMonthName);
        const monthLabel = document.createElement('div');
        monthLabel.className = 'month-label';
        monthLabel.textContent = currentMonthName;
        // Calculate left position based on week index * (cell width + gap)
        // 11px cell + 3px gap = 14px per column
        monthLabel.style.left = `${w * 14}px`; 
        monthsRow.appendChild(monthLabel);
      }

      // Generate 7 days for this week (Sun - Sat)
      for (let d = 0; d < 7; d++) {
        const dateStr = currentDate.toISOString().split('T')[0];
        const count = data[dateStr] || 0;

        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.title = `${dateStr}: ${count} applications`; // Tooltip

        // Don't show future dates (color them empty), but keep element for grid structure
        if (currentDate <= today) {
          if (count > 0) cell.classList.add('level-1');
          if (count > 1) cell.classList.add('level-2');
          if (count > 3) cell.classList.add('level-3');
          if (count > 5) cell.classList.add('level-4');
        }

        weekCol.appendChild(cell);
        
        // Advance one day
        currentDate.setDate(currentDate.getDate() + 1);
      }
      gridRow.appendChild(weekCol);
    }

    // 4. Assemble
    contentCol.appendChild(monthsRow);
    contentCol.appendChild(gridRow);
    
    // Add Legend at bottom of content
    const legend = document.createElement('div');
    legend.className = 'heatmap-legend';
    legend.innerHTML = `
      <span>Less</span>
      <div class="day-cell"></div>
      <div class="day-cell level-1"></div>
      <div class="day-cell level-2"></div>
      <div class="day-cell level-3"></div>
      <div class="day-cell level-4"></div>
      <span>More</span>
    `;
    contentCol.appendChild(legend);

    wrapper.appendChild(contentCol);
    container.appendChild(wrapper);
  }

  // --- (Existing Helper Functions for List) ---
  function reloadApplications() {
    fetch("/applications.json", { headers: { Accept: "application/json" } })
      .then(r => r.json())
      .then(rows => {
        allApplications = Array.isArray(rows) ? rows : (rows.applications || []);
        currentPage = 1;
        populateMonthFilter();
        renderApplicationsFiltered();
      })
      .catch(e => console.error(e));
  }
  
  // (Keep the rest of your renderApplications/filtering logic here...)
  let allApplications = [];
  let filteredApplications = [];
  let currentStatusFilter = "";
  let currentMonthFilter = "";
  let pageSize = 20;
  let currentPage = 1;
  
  function populateMonthFilter() { /* ... keep existing ... */ }
  function renderApplicationsFiltered() { /* ... keep existing ... */ }
  function renderApplicationsPage() { /* ... keep existing ... */ }
  function renderApplications(rows) { 
    const tbody = document.getElementById("apps-body");
    if(!tbody) return;
    tbody.innerHTML = "";
    if(!rows.length) { tbody.innerHTML = "<tr><td colspan='6' class='muted'>No applications</td></tr>"; return; }
    
    rows.forEach(app => {
      const tr = document.createElement("tr");
      // Simplified render for brevity, ensure you copy your FULL render logic back if replacing
      tr.innerHTML = `
        <td>${app.applied_on || "—"}</td>
        <td>${app.company}</td>
        <td>${app.title}</td>
        <td><span class="status-pill">${app.status}</span></td>
        <td>Actions</td>
        <td>${app.url ? `<a href="${app.url}" target="_blank">View</a>` : "—"}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  // (Include rest of your JS helpers here)
</script>