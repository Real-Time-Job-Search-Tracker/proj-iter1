<style>
  /* --- Heatmap Styles (GitHub Style) --- */
  .heatmap-wrapper {
    display: flex;
    align-items: flex-end; /* Align weekday labels with bottom of chart */
    gap: 8px;
    width: 100%;
    overflow-x: auto;
    padding-bottom: 10px;
  }

  /* Left column: Weekday labels (Mon, Wed, Fri) */
  .heatmap-weekdays {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 130px; /* 7 cells * 16px + 6 gaps * 3px = ~130px */
    padding-top: 25px; /* Offset for month labels */
    padding-right: 5px;
    font-size: 11px;
    color: #656d76;
    line-height: 1;
  }
  
  .weekday-label {
    height: 16px; /* Match cell height */
    display: flex;
    align-items: center;
  }

  /* Main chart area */
  .heatmap-content {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  /* Top row: Month labels */
  .heatmap-months {
    display: flex;
    height: 15px;
    position: relative; /* For absolute positioning of months if needed, or flex */
  }
  
  .month-label {
    font-size: 10px;
    color: #656d76;
    position: absolute; /* We will position these via JS */
    top: 0;
  }

  /* The Grid: Flex row of "Week Columns" */
  .heatmap-grid {
    display: flex;
    gap: 3px;
  }

  /* A single column representing one week (Sun-Sat) */
  .heatmap-week {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  /* Individual Day Cell */
  .day-cell {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    background-color: #ebedf0; /* GitHub empty color */
    box-sizing: border-box;
    border: 1px solid rgba(27, 31, 35, 0.06);
  }
  
  /* GitHub Color Scale */
  .day-cell.level-1 { background-color: #9be9a8; border-color: rgba(27, 31, 35, 0.06); }
  .day-cell.level-2 { background-color: #40c463; border-color: rgba(27, 31, 35, 0.06); }
  .day-cell.level-3 { background-color: #30a14e; border-color: rgba(27, 31, 35, 0.06); }
  .day-cell.level-4 { background-color: #216e39; border-color: rgba(27, 31, 35, 0.06); }

  /* Legend Styles */
  .heatmap-legend {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
    margin-top: 8px;
    font-size: 10px;
    color: #656d76;
  }

  /* --- Layout Styles (Card) --- */
  .charts-row {
    display: grid; 
    grid-template-columns: 2fr 1fr; 
    gap: 1.5rem; 
    margin-bottom: 1.5rem;
    width: 100%;
    box-sizing: border-box;
  }

  .chart-card {
    min-height: 280px; 
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    background: #fff;
    border-radius: 12px;
    box-sizing: border-box; 
  }

  .chart-card h2 {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 1.5rem;
    color: #24292f;
  }

  /* View toggle buttons */
  .view-toggle-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    color: #6b7280;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .view-toggle-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }
  
  .view-toggle-btn.active {
    background: linear-gradient(135deg, #4f46e5, #6366f1);
    color: #ffffff;
    border-color: transparent;
  }
  
  .view-container {
    margin-top: 1rem;
  }

  @media (max-width: 900px) {
    .charts-row { 
      grid-template-columns: 1fr; 
      gap: 1rem;
    }
  }
</style>

<h1>Dashboard</h1>

<div class="brand-strip">
  <div class="brand-strip-inner">
    <div class="brand-strip-left">
      <span class="brand-strip-title">Land your dream job</span>
      <span class="brand-strip-divider"></span>
    </div>

    <div class="brand-strip-scroller">
      <div class="logo-slider">
        <div class="logo-track">
          <% logos = %w[
            Google Amazon Meta Microsoft Apple OpenAI Netflix NVIDIA Tesla IBM
            Oracle Salesforce Adobe Intel Uber Airbnb Spotify LinkedIn ByteDance Huawei
          ] %>

          <% 2.times do %>
            <% logos.each do |logo| %>
              <span class="brand-logo"><%= logo %></span>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">

  <div class="card app-add-card">
    <div class="panel-header">
      <h2 class="app-form-title">Add an application</h2>
    </div>

    <%= form_with url: applications_path,
                  method: :post,
                  id: "new_application",
                  data: { turbo: false },
                  html: { class: "app-form-inline" } do %>

      <div class="fld url">
        <label for="application_url">Final apply URL</label>
        <%= text_field_tag "application[url]", "", id: "application_url", type: "url", placeholder: "Paste a job URL...", class: "app-input" %>
      </div>

      <div class="fld date">
        <label for="application_applied_on">Applied on</label>
        <%= date_field_tag "application[applied_on]", Date.today, id: "application_applied_on", class: "app-input" %>
      </div>

      <div class="fld status">
        <label for="application_status">Status</label>
        <%= select_tag "application[status]", options_for_select(%w[Applied Round1 Round2 Interview Offer Accepted Declined Ghosted], "Applied"), id: "application_status", class: "app-input" %>
      </div>

      <div class="fld company">
        <label for="application_company">Company</label>
        <%= text_field_tag "application[company]", "", id: "application_company", class: "app-input-sm" %>
      </div>

      <div class="fld title">
        <label for="application_title">Title</label>
        <%= text_field_tag "application[title]", (current_user&.default_job_title || ""), id: "application_title", class: "app-input-sm", list: "title_suggestions" %>
        <datalist id="title_suggestions">
          <% ["Software Engineer", "Product Manager", "Data Scientist"].each do |t| %>
            <option value="<%= t %>"></option>
          <% end %>
        </datalist>
      </div>

      <%= submit_tag "Add Application", class: "btn small-add" %>
    <% end %>
    <div class="msg" id="msg"></div>
  </div>

  <div class="charts-row">
    
    <div class="card chart-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Application Activity</h2>
        <span style="font-size:0.85rem; color:#656d76;">Last 6 months</span>
      </div>
      
      <div id="heatmap-container" style="flex: 1; display: flex; align-items: center; justify-content: center; overflow-x: auto; width: 100%;">
        </div>
    </div>

    <div class="card chart-card">
      <h2>Status Distribution</h2>
      <div id="status-donut" style="width: 100%; height: 100%; min-height: 220px;"></div>
    </div>
    
  </div>

  <div class="section card">
    <h2>Funnel (Sankey)</h2>
    <div id="sankey"></div>
  </div>

  <div class="section card">
    <div class="panel-header" style="display:flex; justify-content:space-between; align-items:center;">
      <div style="display:flex; align-items:center; gap:8px;">
        <h2 style="margin:0;">Applications</h2>
        <button id="edit-all-btn" class="edit-all-btn" onclick="window.toggleEditAllMode()" title="Edit all applications">
          <span class="edit-icon">‚úèÔ∏è</span>
          <span class="edit-text" style="font-size:12px; margin-left:4px;">Edit</span>
        </button>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="view-table-btn" class="view-toggle-btn active" onclick="switchView('table')">Table</button>
        <button id="view-chart-btn" class="view-toggle-btn" onclick="switchView('chart')">Chart</button>
      </div>
    </div>
    <div id="table-view" class="view-container">
      <div class="table-wrap">
         <table id="apps-table">
           <thead>
             <tr><th>Company</th><th>Applied on</th><th>Link</th><th>Status</th></tr>
           </thead>
           <tbody id="apps-body"></tbody>
         </table>
      </div>
    </div>
    <div id="chart-view" class="view-container" style="display:none;">
      <div id="applications-chart" style="width: 100%; height: 400px;"></div>
    </div>
  </div>

</div>

<script>
  // 1. Data Injection
  window.FAKE_JOBS = <%= raw((@apps || []).to_json) %>;
  window.SANKEY_DATA = <%= raw(@sankey_data.to_json) %>;
  window.DEMO_MODE = <%= (@demo_mode || false).to_json %>;
  window.STATUS_DATA = <%= raw(@status_data.to_json) %>;
  window.HEATMAP_DATA = <%= raw(@heatmap_data.to_json) %>;

  document.addEventListener("DOMContentLoaded", () => {
    renderStatusDonut();
    renderGitHubHeatmap();
    reloadApplications(); // Your existing list loader
    renderApplicationsChart(); // Initialize chart view
  });
  
  // View switching function
  function switchView(view) {
    const tableView = document.getElementById('table-view');
    const chartView = document.getElementById('chart-view');
    const tableBtn = document.getElementById('view-table-btn');
    const chartBtn = document.getElementById('view-chart-btn');
    
    if (view === 'table') {
      tableView.style.display = 'block';
      chartView.style.display = 'none';
      tableBtn.classList.add('active');
      chartBtn.classList.remove('active');
    } else {
      tableView.style.display = 'none';
      chartView.style.display = 'block';
      chartBtn.classList.add('active');
      tableBtn.classList.remove('active');
      renderApplicationsChart(); // Re-render chart when switching
    }
  }
  
  // Toggle edit all mode
  function toggleEditAllMode() {
    const btn = document.getElementById('edit-all-btn');
    const isEditMode = window.editAllMode || false;
    window.editAllMode = !isEditMode;
    
    const allRows = document.querySelectorAll('#apps-body tr');
    allRows.forEach(tr => {
      if (tr.dataset.id) {
        if (!isEditMode) {
          // Enter edit mode
          tr.classList.add('edit-mode');
          tr.querySelectorAll('.cell-display').forEach(el => el.style.display = 'none');
          tr.querySelectorAll('.cell-edit').forEach(el => {
            el.style.display = 'block';
            if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
              el.style.width = '100%';
              el.style.padding = '4px 8px';
              el.style.border = '1px solid #d1d5db';
              el.style.borderRadius = '4px';
            }
          });
        } else {
          // Exit edit mode
          tr.classList.remove('edit-mode');
          tr.querySelectorAll('.cell-display').forEach(el => el.style.display = '');
          tr.querySelectorAll('.cell-edit').forEach(el => el.style.display = 'none');
        }
      }
    });
    
    // Update button
    if (!isEditMode) {
      btn.innerHTML = '<span class="edit-icon">üíæ</span><span class="edit-text" style="font-size:12px; margin-left:4px;">Save</span>';
      btn.title = "Save all changes";
    } else {
      // Save all changes
      saveAllChanges();
      btn.innerHTML = '<span class="edit-icon">‚úèÔ∏è</span><span class="edit-text" style="font-size:12px; margin-left:4px;">Edit</span>';
      btn.title = "Edit all applications";
    }
  }
  
  // Save all changes
  async function saveAllChanges() {
    const allRows = document.querySelectorAll('#apps-body tr[data-id]');
    const updates = [];
    
    for (const tr of allRows) {
      const id = tr.dataset.id;
      const originalData = JSON.parse(tr.dataset.originalData || '{}');
      const newData = {};
      
      // Collect changed fields
      tr.querySelectorAll('.cell-edit').forEach(input => {
        const field = input.dataset.field;
        const newValue = input.value;
        if (field && newValue !== originalData[field]) {
          newData[field] = newValue;
        }
      });
      
      if (Object.keys(newData).length > 0) {
        updates.push({ id, data: newData });
      }
    }
    
    // Save all updates
    for (const update of updates) {
      try {
        await fetch(`/applications/${update.id}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
            "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") || "",
          },
          body: JSON.stringify(update.data),
        });
      } catch (err) {
        console.error(`[save row ${update.id}] failed:`, err);
      }
    }
    
    // Reload data
    if (updates.length > 0) {
      reloadApplications();
      if (window.loadSankey) {
        window.loadSankey();
      }
    }
  }
  
  // statusClass function (needed for board view)
  function statusClass(status) {
    const s = (status || "").toLowerCase();
    if (s.includes("offer")) return "status-offer";
    if (s.includes("declin") || s.includes("reject")) return "status-declined";
    if (s.includes("ghost")) return "status-ghosted";
    if (s.includes("interview") || s.startsWith("round")) return "status-interview";
    if (s.includes("accept")) return "status-accepted";
    return "status-applied";
  }
  
  // Make functions globally available
  window.toggleEditAllMode = toggleEditAllMode;
  window.saveAllChanges = saveAllChanges;
  window.statusClass = statusClass;
  
  // Render applications board view (grouped by status)
  function renderApplicationsChart() {
    const container = document.getElementById('applications-chart');
    if (!container) return;
    
    // Use allApplications if available, otherwise fall back to FAKE_JOBS
    const apps = (typeof allApplications !== 'undefined' && allApplications.length > 0) 
      ? allApplications 
      : (window.FAKE_JOBS || []);
    
    if (apps.length === 0) {
      container.innerHTML = "<div class='muted' style='text-align:center; padding-top:150px;'>No applications to display</div>";
      return;
    }
    
    // Group by status
    const statusGroups = {
      'Applied': [],
      'Round1': [],
      'Round2': [],
      'Interview': [],
      'Offer': [],
      'Accepted': [],
      'Declined': [],
      'Ghosted': []
    };
    
    apps.forEach(app => {
      const status = app.status || 'Applied';
      if (statusGroups[status]) {
        statusGroups[status].push(app);
      } else {
        statusGroups['Applied'].push(app);
      }
    });
    
    // Create board layout
    const boardHTML = `
      <div class="board-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; padding: 1rem;">
        ${Object.keys(statusGroups).map(status => {
          const statusApps = statusGroups[status];
          if (statusApps.length === 0) return '';
          
          return `
            <div class="board-column" style="background: #f9fafb; border-radius: 8px; padding: 1rem; min-height: 200px;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e5e7eb;">
                <span class="status-pill ${statusClass(status)}">${status}</span>
                <span style="font-size: 12px; color: #6b7280;">${statusApps.length}</span>
              </div>
              <div class="board-cards" style="display: flex; flex-direction: column; gap: 0.75rem;">
                ${statusApps.map(app => {
                  const appliedOn = app.applied_on || (app.created_at ? app.created_at.slice(0, 10) : '‚Äî');
                  const linkDisplay = app.url ? (app.url.length > 40 ? app.url.substring(0, 40) + '...' : app.url) : '‚Äî';
                  return `
                    <div class="board-card" style="background: white; border-radius: 6px; padding: 0.75rem; border: 1px solid #e5e7eb; cursor: pointer;" onclick="window.open('${app.url || '#'}', '_blank')">
                      <div style="font-weight: 600; margin-bottom: 0.5rem; color: #111827;">${app.company || 'Unknown'}</div>
                      <div style="font-size: 12px; color: #6b7280; margin-bottom: 0.25rem;">${app.title || ''}</div>
                      <div style="font-size: 11px; color: #9ca3af; margin-bottom: 0.5rem;">${appliedOn}</div>
                      ${app.url ? `<div style="font-size: 11px; color: #6366f1; text-decoration: underline; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${app.url}">${linkDisplay}</div>` : ''}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
    
    container.innerHTML = boardHTML;
  }

  // --- Logic for Status Donut Chart (Plotly) ---
  function renderStatusDonut() {
    const dataObj = window.STATUS_DATA || {};
    const labels = Object.keys(dataObj);
    const values = Object.values(dataObj);

    if (labels.length === 0) {
      document.getElementById('status-donut').innerHTML = "<div class='muted' style='text-align:center; padding-top:80px;'>No data available</div>";
      return;
    }

    const colorMap = {
      "Applied": "#3b82f6", "Round1": "#8b5cf6", "Round2": "#d946ef", "Interview": "#a855f7",
      "Offer": "#22c55e", "Accepted": "#15803d", "Rejected": "#ef4444", 
      "Declined": "#f59e0b", "Ghosted": "#94a3b8"
    };
    const colors = labels.map(l => colorMap[l] || "#cbd5e1");

    const data = [{
      values: values,
      labels: labels,
      type: 'pie',
      hole: 0.6, 
      marker: { colors: colors },
      textinfo: 'label+value', 
      hoverinfo: 'label+percent',
      showlegend: false
    }];

    const layout = {
      autosize: true,
      margin: { t: 10, b: 50, l: 10, r: 10 }, 
      paper_bgcolor: "rgba(0,0,0,0)",
      font: { family: 'Manrope, sans-serif', size: 14 }
    };

    if (document.getElementById('status-donut')) {
      Plotly.newPlot('status-donut', data, layout, {displayModeBar: false});
    }
  }

  // --- Logic for GitHub-style 6 Month Heatmap ---
  function renderGitHubHeatmap() {
    const container = document.getElementById('heatmap-container');
    if (!container) return;

    const data = window.HEATMAP_DATA || {};
    
    // 1. Calculate Date Range (Last 6 Months, aligned to Sunday)
    const today = new Date();
    // Go back ~26 weeks (approx 6 months)
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - (26 * 7));
    
    // Adjust start date to the nearest preceding Sunday
    const dayOfWeek = startDate.getDay(); // 0 is Sunday
    startDate.setDate(startDate.getDate() - dayOfWeek);

    // 2. Build DOM Structure
    // Wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'heatmap-wrapper';

    // Left Column: Weekdays
    const weekdaysCol = document.createElement('div');
    weekdaysCol.className = 'heatmap-weekdays';
    // Calculate positions: cell height (16px) + gap (3px) = 19px per row
    // Mon is row 1 (index 1), Wed is row 3 (index 3), Fri is row 5 (index 5)
    // Plus 25px padding-top for month labels
    const cellHeight = 16;
    const gap = 3;
    const rowHeight = cellHeight + gap;
    const monPos = 25 + (1 * rowHeight) - (cellHeight / 2); // Center of row 1
    const wedPos = 25 + (3 * rowHeight) - (cellHeight / 2); // Center of row 3
    const friPos = 25 + (5 * rowHeight) - (cellHeight / 2); // Center of row 5
    weekdaysCol.innerHTML = `
      <div class="weekday-label" style="margin-top: ${monPos}px;">Mon</div>
      <div class="weekday-label" style="margin-top: ${wedPos}px;">Wed</div>
      <div class="weekday-label" style="margin-top: ${friPos}px;">Fri</div>
    `;
    wrapper.appendChild(weekdaysCol);

    // Right Content: Months + Grid
    const contentCol = document.createElement('div');
    contentCol.className = 'heatmap-content';

    // Month Row
    const monthsRow = document.createElement('div');
    monthsRow.className = 'heatmap-months';
    
    // Grid Row
    const gridRow = document.createElement('div');
    gridRow.className = 'heatmap-grid';

    // 3. Generate Weeks and Days
    let currentDate = new Date(startDate);
    const monthsAdded = new Set(); // To track which months we've added labels for

    // Generate 27 columns (weeks) to cover the range fully
    for (let w = 0; w < 27; w++) {
      const weekCol = document.createElement('div');
      weekCol.className = 'heatmap-week';

      // Check month for the top label (check the first day of this week)
      const currentMonthName = currentDate.toLocaleString('default', { month: 'short' });
      // Only add label if it's a new month and we are not in the very first week (to avoid cutoff)
      if (!monthsAdded.has(currentMonthName) && w > 0) {
        monthsAdded.add(currentMonthName);
        const monthLabel = document.createElement('div');
        monthLabel.className = 'month-label';
        monthLabel.textContent = currentMonthName;
        // Calculate left position based on week index * (cell width + gap)
        // 11px cell + 3px gap = 14px per column
        monthLabel.style.left = `${w * 19}px`; // 16px cell + 3px gap = 19px per column 
        monthsRow.appendChild(monthLabel);
      }

      // Generate 7 days for this week (Sun - Sat)
      for (let d = 0; d < 7; d++) {
        const dateStr = currentDate.toISOString().split('T')[0];
        const count = data[dateStr] || 0;

        const cell = document.createElement('div');
        cell.className = 'day-cell';
        cell.title = `${dateStr}: ${count} applications`; // Tooltip

        // Don't show future dates (color them empty), but keep element for grid structure
        if (currentDate <= today) {
          if (count > 0) cell.classList.add('level-1');
          if (count > 1) cell.classList.add('level-2');
          if (count > 3) cell.classList.add('level-3');
          if (count > 5) cell.classList.add('level-4');
        }

        weekCol.appendChild(cell);
        
        // Advance one day
        currentDate.setDate(currentDate.getDate() + 1);
      }
      gridRow.appendChild(weekCol);
    }

    // 4. Assemble
    contentCol.appendChild(monthsRow);
    contentCol.appendChild(gridRow);
    
    // Add Legend at bottom of content
    const legend = document.createElement('div');
    legend.className = 'heatmap-legend';
    legend.innerHTML = `
      <span>Less</span>
      <div class="day-cell"></div>
      <div class="day-cell level-1"></div>
      <div class="day-cell level-2"></div>
      <div class="day-cell level-3"></div>
      <div class="day-cell level-4"></div>
      <span>More</span>
    `;
    contentCol.appendChild(legend);

    wrapper.appendChild(contentCol);
    container.appendChild(wrapper);
  }

  // --- (Existing Helper Functions for List) ---
  function reloadApplications() {
    fetch("/applications.json", { headers: { Accept: "application/json" } })
      .then(r => r.json())
      .then(rows => {
        allApplications = Array.isArray(rows) ? rows : (rows.applications || []);
        currentPage = 1;
        populateMonthFilter();
        renderApplicationsFiltered();
        // Update chart if chart view is active
        const chartView = document.getElementById('chart-view');
        if (chartView && chartView.style.display !== 'none') {
          renderApplicationsChart();
        }
        
        // Restore edit mode if it was active
        if (window.editAllMode) {
          setTimeout(() => {
            const btn = document.getElementById('edit-all-btn');
            if (btn) {
              btn.click();
              btn.click(); // Toggle twice to re-enter edit mode
            }
          }, 100);
        }
      })
      .catch(e => console.error(e));
  }
  
  // (Keep the rest of your renderApplications/filtering logic here...)
  let allApplications = [];
  let filteredApplications = [];
  let currentStatusFilter = "";
  let currentMonthFilter = "";
  let pageSize = 20;
  let currentPage = 1;
  
  function populateMonthFilter() { 
    // Filter logic can be added here if needed
  }
  
  function renderApplicationsFiltered() {
    // Use the renderFilteredApps from application.js if available
    if (window.renderFilteredApps) {
      window.renderFilteredApps();
    } else {
      // Fallback: render directly
      const tbody = document.getElementById("apps-body");
      if (!tbody) return;
      
      const apps = allApplications || [];
      if (!apps.length) {
        tbody.innerHTML = '<tr><td colspan="4" class="muted">No applications yet</td></tr>';
        return;
      }
      
      const isEditMode = window.editAllMode || false;
      
      apps.forEach(row => {
        const appliedOn = row.applied_on || (row.created_at ? row.created_at.slice(0, 10) : "");
        const linkDisplay = row.url ? (row.url.length > 30 ? row.url.substring(0, 30) + '...' : row.url) : '‚Äî';
        
        const tr = document.createElement("tr");
        tr.dataset.id = row.id;
        tr.dataset.originalData = JSON.stringify({
          company: row.company || '',
          applied_on: appliedOn,
          url: row.url || '',
          status: row.status || 'Applied'
        });
        
        tr.innerHTML = `
          <td class="company-cell">
            <span class="cell-display">${row.company ?? ""}</span>
            <input type="text" class="cell-edit" value="${row.company ?? ""}" style="display:none;" data-field="company">
          </td>
          <td class="date-cell">
            <span class="cell-display">${appliedOn || "‚Äî"}</span>
            <input type="date" class="cell-edit" value="${appliedOn || ""}" style="display:none;" data-field="applied_on">
          </td>
          <td class="link-cell">
            ${row.url
              ? `<a href="${row.url}" target="_blank" rel="noopener noreferrer" class="table-link-btn cell-display" title="${row.url}">${linkDisplay}</a>`
              : '<span class="cell-display">‚Äî</span>'
            }
            <input type="url" class="cell-edit" value="${row.url || ""}" style="display:none;" data-field="url" placeholder="https://...">
          </td>
          <td class="status-cell">
            <span class="status-pill ${statusClass(row.status || "Applied")} cell-display">
              ${row.status || "Applied"}
            </span>
            <select class="status-select cell-edit" data-id="${row.id}" style="display:none;" data-field="status">
              ${buildStatusOptionsHTML(row.status || "Applied")}
            </select>
          </td>
        `;
        
        if (isEditMode) {
          tr.classList.add('edit-mode');
          tr.querySelectorAll('.cell-display').forEach(el => el.style.display = 'none');
          tr.querySelectorAll('.cell-edit').forEach(el => {
            el.style.display = 'block';
            if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
              el.style.width = '100%';
              el.style.padding = '4px 8px';
              el.style.border = '1px solid #d1d5db';
              el.style.borderRadius = '4px';
            }
          });
        }
        
        tbody.appendChild(tr);
      });
    }
  }
  
  function buildStatusOptionsHTML(current) {
    const options = [
      "Applied",
      "Round1",
      "Round2",
      "Interview",
      "Offer",
      "Accepted",
      "Declined",
      "Ghosted",
    ];
    return options
      .map((opt) => {
        const selected =
          (current || "").toLowerCase() === opt.toLowerCase() ? "selected" : "";
        return `<option value="${opt}" ${selected}>${opt}</option>`;
      })
      .join("");
  }
  // (Include rest of your JS helpers here)
</script>