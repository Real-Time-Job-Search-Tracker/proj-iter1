<h1>Dashboard</h1>

<div class="brand-strip">
  <div class="brand-strip-inner">
    <div class="brand-strip-left">
      <span class="brand-strip-title">Land your dream job</span>
      <span class="brand-strip-divider"></span>
    </div>

    <div class="brand-strip-scroller">
      <div class="logo-slider">
        <div class="logo-track">
          <% logos = %w[
            Google Amazon Meta Microsoft Apple OpenAI Netflix NVIDIA Tesla IBM
            Oracle Salesforce Adobe Intel Uber Airbnb Spotify LinkedIn ByteDance Huawei
          ] %>

          <% 2.times do %>
            <% logos.each do |logo| %>
              <span class="brand-logo"><%= logo %></span>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">

  <div class="card app-add-card">
    <div class="panel-header">
      <h2 class="app-form-title">Add an application</h2>
    </div>

    <%= form_with url: applications_path,
              method: :post,
              id: "new_application",
              data: { turbo: false },
              html: { class: "app-form-inline" } do %>

        <div class="fld url">
            <label for="application_url">
            Final apply URL <span class="app-label-hint">(Paste a job URL)</span>
            </label>
            <%= text_field_tag "application[url]",
                "",
                id: "application_url",
                type: "url",
                placeholder: "Paste a job URL (Lever/Greenhouse/…)",
                class: "app-input" %>
        </div>

        <div class="fld status">
            <label for="application_status">Status</label>
            <%= select_tag "application[status]",
                options_for_select(
                    %w[Applied Round1 Round2 Interview Offer Accepted Declined Ghosted],
                    "Applied"
                ),
                id: "application_status",
                class: "app-input" %>
        </div>

        <div class="fld company">
            <label for="application_company">
            Company <span class="app-label-hint">(optional)</span>
            </label>
            <%= text_field_tag "application[company]",
                "",
                id: "application_company",
                class: "app-input-sm" %>
        </div>

        <div class="fld title">
            <label for="application_title">
            Title <span class="app-label-hint">(optional)</span>
            </label>
            <%= text_field_tag "application[title]",
                "",
                id: "application_title",
                class: "app-input-sm" %>
        </div>

        <%= submit_tag "Add Application", class: "btn small-add" %>

        <% end %>


    <div class="msg" id="msg"></div>
  </div>

  <div class="section card">
    <h2>Funnel (Sankey)</h2>
    <div id="sankey"></div>
  </div>

  <div class="section card">
    <div class="panel-header" style="display:flex;justify-content:space-between;align-items:center;">
      <h2 style="margin:0">Applications</h2>
      <span id="countLabel" class="muted"></span>
    </div>

    <ul id="applications" style="display:none;">
      <% JobApplication.order(created_at: :desc).each do |app| %>
        <li data-company="<%= app.company %>">
          <span class="company"><%= app.company %></span>
          <span class="stage"><%= app.status %></span>
        </li>
      <% end %>
    </ul>

    <div class="table-wrap" style="margin-top:1rem">
      <table>
        <thead>
          <tr>
            <th>Company</th>
            <th>Job posting</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="apps-body"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  window.FAKE_JOBS = <%= raw((@jobs || []).to_json) %>;

  document.addEventListener("DOMContentLoaded", () => {
    reloadApplications();
  });

  function reloadApplications() {
    fetch("/applications.json", { headers: { "Accept": "application/json" } })
      .then((r) => {
        if (!r.ok) throw r;
        return r.json();
      })
      .then((rows) => {
        renderApplications(rows);
      })
      .catch((e) => console.error("Failed to load applications", e));
  }

  function renderApplications(rows) {
    const tbody = document.getElementById("apps-body");
    const countLabel = document.getElementById("countLabel");
    if (!tbody) return;

    tbody.innerHTML = "";

    rows.forEach((app) => {
      const tr = document.createElement("tr");

      const tdCompany = document.createElement("td");
      tdCompany.textContent = app.company || "(unknown company)";
      tr.appendChild(tdCompany);

      const tdLink = document.createElement("td");
      if (app.url) {
        const linkBtn = document.createElement("a");
        linkBtn.href = app.url;
        linkBtn.target = "_blank";
        linkBtn.rel = "noopener noreferrer";
        linkBtn.className = "table-link-btn";
        linkBtn.textContent = "View job";
        tdLink.appendChild(linkBtn);
      } else {
        tdLink.textContent = "—";
      }
      tr.appendChild(tdLink);

      const tdStatus = document.createElement("td");
      const statusSpan = document.createElement("span");
      const statusText = app.status || "Applied";
      statusSpan.className = "status-pill " + statusClass(statusText);
      statusSpan.textContent = statusText;
      tdStatus.appendChild(statusSpan);
      tr.appendChild(tdStatus);

      const tdActions = document.createElement("td");
      tdActions.className = "row-actions";

      const select = document.createElement("select");
      select.className = "status-select";

      const options = ["Applied", "Round1", "Round2", "Interview", "Offer", "Accepted", "Declined", "Ghosted"];
      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        if ((statusText || "").toLowerCase() === opt.toLowerCase()) {
          o.selected = true;
        }
        select.appendChild(o);
      });

      select.addEventListener("change", () => {
        updateApplicationStatus(app.id, select.value);
      });

      const delBtn = document.createElement("button");
      delBtn.type = "button";
      delBtn.className = "row-delete-btn";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", () => {
        if (confirm("Delete this application?")) {
          deleteApplication(app.id);
        }
      });

      tdActions.appendChild(select);
      tdActions.appendChild(delBtn);
      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    });

    if (countLabel) {
      const n = rows.length || 0;
      countLabel.textContent = n === 1 ? "1 item" : `${n} items`;
    }
  }

  function statusClass(status) {
    const s = (status || "").toLowerCase();
    if (s.includes("offer")) return "status-offer";
    if (s.includes("declin") || s.includes("reject")) return "status-declined";
    if (s.includes("ghost")) return "status-ghosted";
    if (s.includes("interview") || s.startsWith("round")) return "status-interview";
    return "status-applied";
  }

  function updateApplicationStatus(id, status) {
    if (!id) return;
    fetch(`/applications/${id}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({ status })
    })
      .then((r) => {
        if (!r.ok && r.status !== 204) throw r;
        window.location.reload();
      })
      .catch((e) => console.error("Status update failed", e));
  }

  function deleteApplication(id) {
    if (!id) return
    fetch(`/applications/${id}`, {
      method: "DELETE",
      headers: { "Accept": "application/json" }
    })
      .then((r) => {
        if (!r.ok && r.status !== 204) throw r;
        window.location.reload();
      })
      .catch((e) => console.error("Delete failed", e));
  }
</script>
