<style>
  .heatmap-wrapper {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    width: 100%;
    overflow-x: auto;
    padding-bottom: 10px;
  }

  .heatmap-weekdays {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 130px;
    padding-top: 25px;
    padding-right: 5px;
    font-size: 11px;
    color: #656d76;
    line-height: 1;
  }

  .weekday-label {
    height: 16px;
    display: flex;
    align-items: center;
  }

  .heatmap-content {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .heatmap-months {
    display: flex;
    height: 15px;
    position: relative;
  }

  .month-label {
    font-size: 10px;
    color: #656d76;
    position: absolute;
    top: 0;
  }

  .heatmap-grid {
    display: flex;
    gap: 3px;
  }

  .heatmap-week {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .day-cell {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    background-color: #ebedf0;
    box-sizing: border-box;
    border: 1px solid rgba(27, 31, 35, 0.06);
  }

  .day-cell.level-1 { background-color: #9be9a8; border-color: rgba(27, 31, 35, 0.06); }
  .day-cell.level-2 { background-color: #40c463; border-color: rgba(27, 31, 35, 0.06); }
  .day-cell.level-3 { background-color: #30a14e; border-color: rgba(27, 31, 35, 0.06); }
  .day-cell.level-4 { background-color: #216e39; border-color: rgba(27, 31, 35, 0.06); }

  .heatmap-legend {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
    margin-top: 8px;
    font-size: 10px;
    color: #656d76;
  }

  .charts-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    width: 100%;
    box-sizing: border-box;
  }

  .chart-card {
    min-height: 280px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    background: #fff;
    border-radius: 12px;
    box-sizing: border-box;
  }

  .chart-card h2 {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 1.5rem;
    color: #24292f;
  }

  .view-toggle-btn {
    padding: 8px 16px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    color: #6b7280;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .view-toggle-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
  }

  .view-toggle-btn.active {
    background: linear-gradient(135deg, #4f46e5, #6366f1);
    color: #ffffff;
    border-color: transparent;
  }

  .view-container {
    margin-top: 1rem;
  }

  .edit-all-btn {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    font-size: 12px;
    cursor: pointer;
    gap: 4px;
  }

  .edit-all-btn:hover {
    background: #eef2ff;
    border-color: #c7d2fe;
  }

  @media (max-width: 900px) {
    .charts-row {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
  }
</style>

<h1>Dashboard</h1>

<div class="brand-strip">
  <div class="brand-strip-inner">
    <div class="brand-strip-left">
      <span class="brand-strip-title">Land your dream job</span>
      <span class="brand-strip-divider"></span>
    </div>

    <div class="brand-strip-scroller">
      <div class="logo-slider">
        <div class="logo-track">
          <% logos = %w[
            Google Amazon Meta Microsoft Apple OpenAI Netflix NVIDIA Tesla IBM
            Oracle Salesforce Adobe Intel Uber Airbnb Spotify LinkedIn ByteDance Huawei
          ] %>

          <% 2.times do %>
            <% logos.each do |logo| %>
              <span class="brand-logo"><%= logo %></span>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container">

  <div class="card app-add-card">
    <div class="panel-header">
      <h2 class="app-form-title">Add an application</h2>
    </div>

    <%= form_with url: applications_path,
                  method: :post,
                  id: "new_application",
                  data: { turbo: false },
                  html: { class: "app-form-inline" } do %>

      <div class="fld url">
        <label for="application_url">
          Final apply URL <span class="app-label-hint">(Paste a job URL)</span>
        </label>
        <%= text_field_tag "application[url]",
              "",
              id: "application_url",
              type: "url",
              placeholder: "Paste a job URL (Lever/Greenhouse/…)",
              class: "app-input" %>
      </div>

      <div class="fld status">
        <label for="application_status">Status</label>
        <%= select_tag "application[status]",
              options_for_select(
                %w[Applied Round1 Round2 Interview Offer Accepted Declined Ghosted],
                "Applied"
              ),
              id: "application_status",
              class: "app-input" %>
      </div>

      <div class="fld company">
        <label for="application_company">
          Company <span class="app-label-hint">(optional)</span>
        </label>
        <%= text_field_tag "application[company]",
              "",
              id: "application_company",
              class: "app-input-sm" %>
      </div>

      <div class="fld title">
        <label for="application_title">
          Title <span class="app-label-hint">(optional)</span>
        </label>

        <%= text_field_tag "application[title]",
              (current_user&.default_job_title || ""),
              id: "application_title",
              class: "app-input-sm",
              list: "title_suggestions" %>

        <% cs_titles = [
            "Software Engineer",
            "Backend Engineer",
            "Frontend Engineer",
            "Fullstack Engineer",
            "Machine Learning Engineer",
            "Data Scientist"
          ] %>

        <% ds_titles = [
            "Data Scientist",
            "Data Analyst",
            "Machine Learning Engineer",
            "Business Intelligence Analyst",
            "Quant Researcher"
          ] %>

        <% ba_titles = [
            "Business Analyst",
            "Product Analyst",
            "Data Analyst",
            "Operations Analyst"
          ] %>

        <% default_titles = User::JOB_TITLES %>

        <% track = current_user&.student_track %>

        <% suggested_titles =
            case track
            when "Computer Science", "Software Engineering", "Computer Science / CS"
              cs_titles
            when "Data Science", "Data Science / DS"
              ds_titles
            when "Business Analytics", "BA / Business Analytics"
              ba_titles
            else
              default_titles
            end %>

        <datalist id="title_suggestions">
          <% suggested_titles.each do |t| %>
            <option value="<%= t %>"></option>
          <% end %>
        </datalist>
      </div>

      <%= submit_tag "Add Application", class: "btn small-add" %>

    <% end %>

    <div class="msg" id="msg"></div>
  </div>

  <!-- 新加：上面的两个图（heatmap + status donut） -->
  <div class="charts-row">
    <div class="card chart-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Application Activity</h2>
        <span style="font-size:0.85rem; color:#656d76;">Last 6 months</span>
      </div>
      <div id="heatmap-container"
           style="flex: 1; display: flex; align-items: center; justify-content: center; overflow-x: auto; width: 100%;">
      </div>
    </div>

    <div class="card chart-card">
      <h2>Status Distribution</h2>
      <div id="status-donut" style="width: 100%; height: 100%; min-height: 220px;"></div>
    </div>
  </div>

  <div class="section card">
    <h2>Funnel (Sankey)</h2>
    <div id="sankey"></div>
  </div>

  <!-- Applications 主块：用队员新的 manage + 你的 Edit + Table/Chart -->
  <div class="section card">
    <div class="panel-header" style="display:flex;justify-content:space-between;align-items:center;">
      <div style="display:flex;align-items:center;gap:8px;">
        <h2 style="margin:0">Applications</h2>
        <button id="edit-all-btn" type="button" class="edit-all-btn">
          <span class="edit-icon">✏️</span>
          <span class="edit-text" style="font-size:12px; margin-left:4px;">Edit</span>
        </button>
      </div>

      <div style="display:flex;align-items:center;gap:0.75rem;">
        <span id="countLabel" class="muted"></span>

        <select id="statusFilter" class="status-filter">
          <option value="">All statuses</option>
          <option value="Applied">Applied</option>
          <option value="Round1">Round1</option>
          <option value="Round2">Round2</option>
          <option value="Interview">Interview</option>
          <option value="Offer">Offer</option>
          <option value="Accepted">Accepted</option>
          <option value="Declined">Declined</option>
          <option value="Ghosted">Ghosted</option>
        </select>

        <select id="monthFilter" class="status-filter">
          <option value="">All months</option>
        </select>

        <button id="view-table-btn"
                type="button"
                class="view-toggle-btn active">
          Table
        </button>
        <button id="view-chart-btn"
                type="button"
                class="view-toggle-btn">
          Chart
        </button>
      </div>
    </div>


    <div id="table-view" class="view-container">
      <ul id="applications" style="display:none;">
        <% JobApplication.order(created_at: :desc).each do |app| %>
          <li data-company="<%= app.company %>">
            <span class="company"><%= app.company %></span>
            <span class="stage"><%= app.status %></span>
          </li>
        <% end %>
      </ul>

      <div id="bulkDeleteBar"
           style="display:flex;justify-content:flex-end;gap:0.5rem;margin-top:0.5rem;">
        <button
          type="button"
          id="bulkDeleteBtn"
          class="row-delete-btn">
          Delete selected
        </button>
      </div>

      <div id="apps-wrapper" style="visibility:hidden;">
        <div class="table-wrap" style="margin-top:0.5rem">
          <table id="apps-table">
            <thead>
              <tr>
                <th id="manageHeader" style="width:32px;display:none;"></th>
                <th>Applied on</th>
                <th>Company</th>
                <th>Title</th>
                <th>Status</th>
                <th>Actions</th>
                <th>Job posting</th>
              </tr>
            </thead>
            <tbody id="apps-body"></tbody>
          </table>
        </div>

        <div id="paginationBar"
             style="display:flex;justify-content:space-between;align-items:center;margin-top:0.75rem;">
          <span id="pageInfo" class="muted"></span>
          <div style="display:flex;align-items:center;gap:0.5rem;">
            <span class="muted" style="font-size:0.85rem;">Rows per page</span>
            <select id="pageSize" class="status-filter">
              <option value="10">10</option>
              <option value="20" selected>20</option>
              <option value="50">50</option>
              <option value="0">All</option>
            </select>
            <button type="button" id="prevPage" class="btn small-add" style="padding-inline:0.75rem;">
              ‹
            </button>
            <button type="button" id="nextPage" class="btn small-add" style="padding-inline:0.75rem;">
              ›
            </button>
          </div>
        </div>
      </div>


    <div id="chart-view" class="view-container" style="display:none;">
      <div id="applications-chart" style="width: 100%; height: 400px;"></div>
    </div>
  </div>
</div>

<script>
  window.FAKE_JOBS   = <%= raw((@jobs || []).to_json) %>;
  window.SANKEY_DATA = <%= raw((@sankey_data || {}).to_json) %>;
  window.STATUS_DATA = <%= raw((@status_data || {}).to_json) %>;
  window.HEATMAP_DATA = <%= raw((@heatmap_data || {}).to_json) %>;

  let allApplications = [];
  let filteredApplications = [];
  let currentStatusFilter = "";
  let currentMonthFilter = "";
  let managingState = false;
  let pageSize = 20;
  let currentPage = 1;

  document.addEventListener("DOMContentLoaded", () => {
    const statusFilter   = document.getElementById("statusFilter");
    const monthFilter    = document.getElementById("monthFilter");
    const pageSizeSelect = document.getElementById("pageSize");
    const prevPageBtn    = document.getElementById("prevPage");
    const nextPageBtn    = document.getElementById("nextPage");
    const bulkDeleteBtn  = document.getElementById("bulkDeleteBtn");
    const editBtn        = document.getElementById("edit-all-btn");
    const tableBtn       = document.getElementById("view-table-btn");
    const chartBtn       = document.getElementById("view-chart-btn");

    const urlInput     = document.getElementById("application_url");
    const companyInput = document.getElementById("application_company");
    const titleInput   = document.getElementById("application_title");
    const msgEl        = document.getElementById("msg");

    if (urlInput && companyInput && titleInput) {
      let urlTimer = null;
      const runInspect = () => {
        const url = (urlInput.value || "").trim();
        if (!url) return;
        if (msgEl) msgEl.textContent = "Looking up job details…";

        fetch(`/jobs/inspect?url=${encodeURIComponent(url)}`, {
          headers: { Accept: "application/json" }
        })
          .then((r) => {
            if (!r.ok) throw r;
            return r.json();
          })
          .then((data) => {
            if (data.company && !companyInput.value) {
              companyInput.value = data.company;
            }
            if (data.title && !titleInput.value) {
              titleInput.value = data.title;
            }
            if (msgEl) msgEl.textContent = "";
          })
          .catch(() => {
            if (msgEl) msgEl.textContent = "";
          });
      };

      urlInput.addEventListener("blur", runInspect);
      urlInput.addEventListener("paste", () => {
        if (urlTimer) clearTimeout(urlTimer);
        urlTimer = setTimeout(runInspect, 150);
      });
      urlInput.addEventListener("keydown", () => {
        if (urlTimer) clearTimeout(urlTimer);
      });
    }

    if (statusFilter) {
      statusFilter.addEventListener("change", () => {
        currentStatusFilter = statusFilter.value;
        currentPage = 1;
        renderApplicationsFiltered();
      });
    }

    if (monthFilter) {
      monthFilter.addEventListener("change", () => {
        currentMonthFilter = monthFilter.value;
        currentPage = 1;
        renderApplicationsFiltered();
      });
    }

    if (pageSizeSelect) {
      pageSizeSelect.addEventListener("change", () => {
        const v = parseInt(pageSizeSelect.value, 10);
        pageSize = isNaN(v) ? 20 : v;
        currentPage = 1;
        renderApplicationsFiltered();
      });
    }

    if (bulkDeleteBtn) {
      const cloned = bulkDeleteBtn.cloneNode(true);
      bulkDeleteBtn.parentNode.replaceChild(cloned, bulkDeleteBtn);
      cloned.addEventListener("click", handleBulkDelete);
    }

    if (prevPageBtn) {
      prevPageBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage -= 1;
          renderApplicationsPage();
        }
      });
    }

    if (nextPageBtn) {
      nextPageBtn.addEventListener("click", () => {
        const total = filteredApplications.length;
        const effectiveSize = pageSize && pageSize > 0 ? pageSize : total || 1;
        const totalPages = Math.max(1, Math.ceil(total / effectiveSize));
        if (currentPage < totalPages) {
          currentPage += 1;
          renderApplicationsPage();
        }
      });
    }

    if (editBtn) {
      editBtn.addEventListener("click", () => {
        managingState = !managingState;
        updateManageUI();
        renderApplicationsFiltered();
      });
    }

    if (tableBtn && chartBtn) {
      tableBtn.addEventListener("click", () => switchView("table"));
      chartBtn.addEventListener("click", () => switchView("chart"));
    }

    renderStatusDonut();
    renderGitHubHeatmap();
    reloadApplications();
  });

  function switchView(view) {
    const tableView = document.getElementById("table-view");
    const chartView = document.getElementById("chart-view");
    const tableBtn = document.getElementById("view-table-btn");
    const chartBtn = document.getElementById("view-chart-btn");

    if (!tableView || !chartView || !tableBtn || !chartBtn) return;

    if (view === "table") {
      tableView.style.display = "block";
      chartView.style.display = "none";
      tableBtn.classList.add("active");
      chartBtn.classList.remove("active");
    } else {
      tableView.style.display = "none";
      chartView.style.display = "block";
      chartBtn.classList.add("active");
      tableBtn.classList.remove("active");
      managingState = false;
      updateManageUI();
      renderApplicationsChart();
    }
  }

  function extractDate(app) {
    if (app.applied_on) return app.applied_on;
    if (app.created_at) return app.created_at.slice(0, 10);
    return "";
  }

  function extractMonth(app) {
    const d = extractDate(app);
    return d ? d.slice(0, 7) : "";
  }

  function reloadApplications() {
    fetch("/applications.json", { headers: { Accept: "application/json" } })
      .then((r) => {
        if (!r.ok) throw r;
        return r.json();
      })
      .then((rows) => {
        allApplications = Array.isArray(rows) ? rows : (rows.applications || []);
        currentPage = 1;
        populateMonthFilter();
        renderApplicationsFiltered();
        if (document.getElementById("applications-chart")) {
          renderApplicationsChart();
        }
      })
      .catch((e) => console.error("Failed to load applications", e));
  }

  function populateMonthFilter() {
    const monthFilter = document.getElementById("monthFilter");
    if (!monthFilter) return;

    const prev = monthFilter.value;
    const monthsSet = new Set();

    allApplications.forEach((app) => {
      const m = extractMonth(app);
      if (m) monthsSet.add(m);
    });

    const months = Array.from(monthsSet).sort();
    monthFilter.innerHTML = '<option value="">All months</option>';
    months.forEach((m) => {
      const opt = document.createElement("option");
      opt.value = m;
      opt.textContent = m;
      monthFilter.appendChild(opt);
    });

    if (prev && months.includes(prev)) {
      monthFilter.value = prev;
      currentMonthFilter = prev;
    } else {
      currentMonthFilter = "";
    }
  }

  function renderApplicationsFiltered() {
    let rows = allApplications;

    if (currentStatusFilter) {
      const target = currentStatusFilter.toLowerCase();
      rows = rows.filter(
        (app) => (app.status || "").toLowerCase() === target
      );
    }

    if (currentMonthFilter) {
      rows = rows.filter(
        (app) => extractMonth(app) === currentMonthFilter
      );
    }

    filteredApplications = rows;
    renderApplicationsPage();
  }

  function renderApplicationsPage() {
    const total = filteredApplications.length;
    const countLabel = document.getElementById("countLabel");
    const pageInfo = document.getElementById("pageInfo");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const appsWrapper = document.getElementById("apps-wrapper");

    if (countLabel) {
      countLabel.textContent = total === 1 ? "1 item" : `${total} items`;
    }

    if (!total) {
      renderApplications([]);
      if (pageInfo) pageInfo.textContent = "";
      if (prevPageBtn) prevPageBtn.disabled = true;
      if (nextPageBtn) nextPageBtn.disabled = true;
      if (appsWrapper) appsWrapper.style.visibility = "visible";
      return;
    }


    const effectiveSize = pageSize && pageSize > 0 ? pageSize : total;
    const totalPages = Math.max(1, Math.ceil(total / effectiveSize));

    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * effectiveSize;
    const end = start + effectiveSize;
    const pageRows =
      pageSize && pageSize > 0
        ? filteredApplications.slice(start, end)
        : filteredApplications.slice();

    renderApplications(pageRows);

    if (appsWrapper) {
      appsWrapper.style.visibility = "visible";
    }


    if (pageInfo) {
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
    }
    if (prevPageBtn) prevPageBtn.disabled = currentPage <= 1;
    if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
  }

  function renderApplications(rows) {
    const tbody        = document.getElementById("apps-body");
    const table        = document.getElementById("apps-table");
    const manageHeader = document.getElementById("manageHeader");

    if (!tbody) return;

    tbody.innerHTML = "";

    if (manageHeader) {
      manageHeader.style.display = managingState ? "" : "none";
    }
    if (table) {
      table.dataset.managing = managingState ? "1" : "0";
    }

    if (!rows.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = managingState ? 7 : 6;
      td.className = "muted";
      td.textContent = "No applications yet";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    rows.forEach((app) => {
      const tr = document.createElement("tr");

      if (managingState) {
        const tdSelect = document.createElement("td");
        tdSelect.style.textAlign = "center";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "row-select";
        cb.dataset.id = app.id;
        tdSelect.appendChild(cb);
        tr.appendChild(tdSelect);
      }

      const statusText = app.status || "Applied";

      const tdDate = document.createElement("td");
      const d = extractDate(app);
      tdDate.textContent = d || "—";
      tr.appendChild(tdDate);

      const tdCompany = document.createElement("td");
      tdCompany.textContent = app.company || "(unknown company)";
      tr.appendChild(tdCompany);

      const tdTitle = document.createElement("td");
      tdTitle.textContent = app.title || "—";
      tr.appendChild(tdTitle);

      const tdStatus = document.createElement("td");
      const statusSpan = document.createElement("span");
      statusSpan.className = "status-pill " + statusClass(statusText);
      statusSpan.textContent = statusText;
      tdStatus.appendChild(statusSpan);
      tr.appendChild(tdStatus);

      const tdActions = document.createElement("td");
      tdActions.className = "row-actions";

      const select = document.createElement("select");
      select.className = "status-select";

      const options = [
        "Applied",
        "Round1",
        "Round2",
        "Interview",
        "Offer",
        "Accepted",
        "Declined",
        "Ghosted",
      ];
      options.forEach((opt) => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        if ((statusText || "").toLowerCase() === opt.toLowerCase()) {
          o.selected = true;
        }
        select.appendChild(o);
      });

      select.addEventListener("change", () => {
        updateApplicationStatus(app.id, select.value);
      });

      tdActions.appendChild(select);
      tr.appendChild(tdActions);

      const tdLink = document.createElement("td");
      if (app.url) {
        const linkBtn = document.createElement("a");
        linkBtn.href = app.url;
        linkBtn.target = "_blank";
        linkBtn.rel = "noopener noreferrer";
        linkBtn.className = "table-link-btn";
        linkBtn.textContent = "View job";
        tdLink.appendChild(linkBtn);
      } else {
        tdLink.textContent = "—";
      }
      tr.appendChild(tdLink);

      tbody.appendChild(tr);
    });

    toggleManageCheckboxVisibility();
  }

  function statusClass(status) {
    const s = (status || "").toLowerCase();
    if (s.includes("offer")) return "status-offer";
    if (s.includes("declin") || s.includes("reject")) return "status-declined";
    if (s.includes("ghost")) return "status-ghosted";
    if (s.includes("interview") || s.startsWith("round")) return "status-interview";
    return "status-applied";
  }

  function updateManageUI() {
    const bulkBar      = document.getElementById("bulkDeleteBar");
    const manageHeader = document.getElementById("manageHeader");
    const editBtn      = document.getElementById("edit-all-btn");

    if (bulkBar)      bulkBar.style.display      = managingState ? "flex" : "none";
    if (manageHeader) manageHeader.style.display = managingState ? "" : "none";

    if (!managingState) {
      document.querySelectorAll(".row-select").forEach((cb) => {
        cb.checked = false;
      });
    }

    if (editBtn) {
      if (managingState) {
        editBtn.innerHTML =
          '<span class="edit-icon">✔</span><span class="edit-text" style="font-size:12px; margin-left:4px;">Done</span>';
      } else {
        editBtn.innerHTML =
          '<span class="edit-icon">✏️</span><span class="edit-text" style="font-size:12px; margin-left:4px;">Edit</span>';
      }
    }

    toggleManageCheckboxVisibility();
  }

  function toggleManageCheckboxVisibility() {
    const checkboxes = document.querySelectorAll(".row-select");
    checkboxes.forEach((cb) => {
      cb.style.display = managingState ? "" : "none";
      if (!managingState) cb.checked = false;
    });
  }

  function updateApplicationStatus(id, status) {
    if (!id) return;
    fetch(`/applications/${id}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify({ status }),
    })
      .then((r) => {
        if (!r.ok && r.status !== 204) throw r;
        reloadApplications();
      })
      .catch((e) => console.error("Status update failed", e));
  }

  function handleBulkDelete() {
    const selected = Array.from(
      document.querySelectorAll(".row-select")
    ).filter((cb) => cb.checked && cb.dataset.id);

    if (!selected.length) {
      return;
    }

    const ids = selected.map((cb) => cb.dataset.id);

    Promise.all(
      ids.map((id) =>
        fetch(`/applications/${id}`, {
          method: "DELETE",
          headers: { Accept: "application/json" },
        }).then((r) => {
          if (!r.ok && r.status !== 204) {
            throw new Error(`Delete failed for ${id}`);
          }
        })
      )
    )
      .then(() => {
        managingState = false;
        updateManageUI();
        reloadApplications();
      })
      .catch((e) => {
        console.error("Bulk delete failed", e);
        alert("Bulk delete failed (see console for details)");
      });
  }

  function deleteApplication(id) {
    if (!id) return;
    fetch(`/applications/${id}`, {
      method: "DELETE",
      headers: { Accept: "application/json" }
    })
      .then((r) => {
        if (!r.ok && r.status !== 204) throw r;
        reloadApplications();
      })
      .catch((e) => {
        console.error("Bulk delete failed", e);
        alert("Bulk delete failed (see console for details)");
      });
  }

  function renderApplicationsChart() {
    const container = document.getElementById("applications-chart");
    if (!container) return;

    const apps = (allApplications && allApplications.length > 0)
      ? allApplications
      : (window.FAKE_JOBS || []);

    if (!apps.length) {
      container.innerHTML =
        "<div class='muted' style='text-align:center; padding-top:150px;'>No applications to display</div>";
      return;
    }

    const statusGroups = {
      "Applied": [],
      "Round1": [],
      "Round2": [],
      "Interview": [],
      "Offer": [],
      "Accepted": [],
      "Declined": [],
      "Ghosted": []
    };

    apps.forEach(app => {
      const status = app.status || "Applied";
      if (statusGroups[status]) {
        statusGroups[status].push(app);
      } else {
        statusGroups["Applied"].push(app);
      }
    });

    const boardHTML = `
      <div class="board-container"
           style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;padding:1rem;">
        ${Object.keys(statusGroups).map(status => {
          const statusApps = statusGroups[status];
          if (!statusApps.length) return "";
          return `
            <div class="board-column"
                 style="background:#f9fafb;border-radius:8px;padding:1rem;min-height:200px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:1rem;padding-bottom:0.75rem;border-bottom:2px solid #e5e7eb;">
                <span class="status-pill ${statusClass(status)}">${status}</span>
                <span style="font-size:12px;color:#6b7280;">${statusApps.length}</span>
              </div>
              <div class="board-cards" style="display:flex;flex-direction:column;gap:0.75rem;">
                ${statusApps.map(app => {
                  const appliedOn = app.applied_on || (app.created_at ? app.created_at.slice(0, 10) : "—");
                  const linkDisplay = app.url
                    ? (app.url.length > 40 ? app.url.substring(0, 40) + "..." : app.url)
                    : "—";
                  return `
                    <div class="board-card"
                         style="background:white;border-radius:6px;padding:0.75rem;border:1px solid #e5e7eb;cursor:pointer;"
                         onclick="window.open('${app.url || "#"}','_blank')">
                      <div style="font-weight:600;margin-bottom:0.5rem;color:#111827;">
                        ${app.company || "Unknown"}
                      </div>
                      <div style="font-size:12px;color:#6b7280;margin-bottom:0.25rem;">
                        ${app.title || ""}
                      </div>
                      <div style="font-size:11px;color:#9ca3af;margin-bottom:0.5rem;">
                        ${appliedOn}
                      </div>
                      ${app.url ? `
                        <div style="font-size:11px;color:#6366f1;text-decoration:underline;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                             title="${app.url}">
                          ${linkDisplay}
                        </div>` : ""}
                    </div>
                  `;
                }).join("")}
              </div>
            </div>
          `;
        }).join("")}
      </div>
    `;
    container.innerHTML = boardHTML;
  }

  function renderStatusDonut() {
    const dataObj = window.STATUS_DATA || {};
    const labels = Object.keys(dataObj);
    const values = Object.values(dataObj);

    if (!labels.length) {
      const el = document.getElementById("status-donut");
      if (el) {
        el.innerHTML =
          "<div class='muted' style='text-align:center; padding-top:80px;'>No data available</div>";
      }
      return;
    }

    const colorMap = {
      "Applied": "#3b82f6", "Round1": "#8b5cf6", "Round2": "#d946ef",
      "Interview": "#a855f7", "Offer": "#22c55e", "Accepted": "#15803d",
      "Rejected": "#ef4444", "Declined": "#f59e0b", "Ghosted": "#94a3b8"
    };
    const colors = labels.map(l => colorMap[l] || "#cbd5e1");

    const data = [{
      values: values,
      labels: labels,
      type: "pie",
      hole: 0.6,
      marker: { colors: colors },
      textinfo: "label+value",
      hoverinfo: "label+percent",
      showlegend: false
    }];

    const layout = {
      autosize: true,
      margin: { t: 10, b: 50, l: 10, r: 10 },
      paper_bgcolor: "rgba(0,0,0,0)",
      font: { family: "Manrope, sans-serif", size: 14 }
    };

    if (document.getElementById("status-donut")) {
      Plotly.newPlot("status-donut", data, layout, { displayModeBar: false });
    }
  }

  function renderGitHubHeatmap() {
    const container = document.getElementById("heatmap-container");
    if (!container) return;

    const data = window.HEATMAP_DATA || {};
    const today = new Date();
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - (26 * 7));
    const dayOfWeek = startDate.getDay();
    startDate.setDate(startDate.getDate() - dayOfWeek);

    const wrapper = document.createElement("div");
    wrapper.className = "heatmap-wrapper";

    const weekdaysCol = document.createElement("div");
    weekdaysCol.className = "heatmap-weekdays";

    const cellHeight = 16;
    const gap = 3;
    const rowHeight = cellHeight + gap;
    const monPos = 25 + (1 * rowHeight) - (cellHeight / 2);
    const wedPos = 25 + (3 * rowHeight) - (cellHeight / 2);
    const friPos = 25 + (5 * rowHeight) - (cellHeight / 2);

    weekdaysCol.innerHTML = `
      <div class="weekday-label" style="margin-top:${monPos}px;">Mon</div>
      <div class="weekday-label" style="margin-top:${wedPos}px;">Wed</div>
      <div class="weekday-label" style="margin-top:${friPos}px;">Fri</div>
    `;
    wrapper.appendChild(weekdaysCol);

    const contentCol = document.createElement("div");
    contentCol.className = "heatmap-content";

    const monthsRow = document.createElement("div");
    monthsRow.className = "heatmap-months";
    const gridRow = document.createElement("div");
    gridRow.className = "heatmap-grid";

    let currentDate = new Date(startDate);
    const monthsAdded = new Set();

    for (let w = 0; w < 27; w++) {
      const weekCol = document.createElement("div");
      weekCol.className = "heatmap-week";

      const currentMonthName = currentDate.toLocaleString("default", { month: "short" });
      if (!monthsAdded.has(currentMonthName) && w > 0) {
        monthsAdded.add(currentMonthName);
        const monthLabel = document.createElement("div");
        monthLabel.className = "month-label";
        monthLabel.textContent = currentMonthName;
        monthLabel.style.left = `${w * 19}px`;
        monthsRow.appendChild(monthLabel);
      }

      for (let d = 0; d < 7; d++) {
        const dateStr = currentDate.toISOString().split("T")[0];
        const count = data[dateStr] || 0;

        const cell = document.createElement("div");
        cell.className = "day-cell";
        cell.title = `${dateStr}: ${count} applications`;

        if (currentDate <= today) {
          if (count > 0) cell.classList.add("level-1");
          if (count > 1) cell.classList.add("level-2");
          if (count > 3) cell.classList.add("level-3");
          if (count > 5) cell.classList.add("level-4");
        }

        weekCol.appendChild(cell);
        currentDate.setDate(currentDate.getDate() + 1);
      }
      gridRow.appendChild(weekCol);
    }

    contentCol.appendChild(monthsRow);
    contentCol.appendChild(gridRow);

    const legend = document.createElement("div");
    legend.className = "heatmap-legend";
    legend.innerHTML = `
      <span>Less</span>
      <div class="day-cell"></div>
      <div class="day-cell level-1"></div>
      <div class="day-cell level-2"></div>
      <div class="day-cell level-3"></div>
      <div class="day-cell level-4"></div>
      <span>More</span>
    `;
    contentCol.appendChild(legend);

    wrapper.appendChild(contentCol);
    container.appendChild(wrapper);
  }
</script>