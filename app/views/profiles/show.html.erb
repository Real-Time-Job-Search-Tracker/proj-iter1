<div class="profile-page">
  <div class="profile-header">
    <h1 class="profile-title">Profile</h1>
    <p class="profile-subtitle">
      Manage your preferences and daily goals.
    </p>
  </div>

  <div class="profile-layout">
    <!-- Left card: basic info -->
    <div class="profile-card">
      <h2 class="profile-section-title">Basic information</h2>

      <%= form_with model: @user,
                    url: profile_path,
                    method: :patch,
                    local: true,
                    multipart: true,
                    class: "profile-form" do |f| %>

        <!-- Avatar -->
        <div class="profile-field-group">
          <label class="profile-label">Profile photo</label>

          <div class="profile-avatar-row">
            <div class="profile-avatar-preview">
              <% if @user.avatar.attached? %>
                <%= image_tag @user.avatar,
                              class: "profile-avatar-image" %>
              <% else %>
                <div class="profile-avatar-placeholder">?</div>
              <% end %>
            </div>

            <div class="profile-avatar-actions">
              <%= f.file_field :avatar,
                               accept: "image/*",
                               class: "profile-file-input" %>
              <p class="profile-hint">
                Upload a square image for best results.
              </p>
            </div>
          </div>

          <!-- 临时调试：看一下 attached? 的结果，确认有没有真正存上去 -->
          <!-- <p style="font-size:12px;color:#9ca3af;margin-top:4px;"> -->
            <!-- avatar attached?: <%= @user.avatar.attached? %> -->
          <!-- </p> -->
        </div>

        <!-- Name -->
        <div class="profile-field-grid">
          <div class="profile-field-group">
            <label class="profile-label">Username</label>
            <%= f.text_field :username,
                             class: "profile-input",
                             placeholder: "Your name" %>
          </div>

          <div class="profile-field-group">
            <label class="profile-label">Email</label>
            <%= f.email_field :email,
                              class: "profile-input profile-input-disabled",
                              disabled: true %>
            <p class="profile-hint">Email changes are not supported here.</p>
          </div>
        </div>

        <!-- Daily goal -->
        <div class="profile-field-group">
          <div class="profile-label-row">
            <label class="profile-label">Daily application goal</label>
            <span class="profile-label-hint">
              How many applications you aim for per day.
            </span>
          </div>
          <%= f.number_field :daily_goal,
                             in: 1..200,
                             class: "profile-input profile-input-small",
                             placeholder: "10" %>
        </div>

        <!-- Student type + default title -->
        <div class="profile-field-grid">
          <div class="profile-field-group">
            <label class="profile-label">Student type</label>
            <%= f.select :student_track,
                         User::STUDENT_TRACKS,
                         { include_blank: "Select a track" },
                         class: "profile-input profile-select" %>
          </div>

          <div class="profile-field-group">
            <label class="profile-label">Default job title</label>
            <%= f.select :default_job_title,
                         User::JOB_TITLES,
                         { include_blank: "Select default title" },
                         class: "profile-input profile-select",
                         id: "default-title-select" %>
          </div>
        </div>

        <!-- Custom title -->
        <div id="custom-title-wrapper"
             class="profile-field-group <%= @user.default_job_title == 'Other' ? '' : 'is-hidden' %>">
          <label class="profile-label">Custom title</label>
          <%= f.text_field :custom_job_title,
                           class: "profile-input",
                           placeholder: "e.g. Research Engineer" %>
        </div>

        <div class="profile-actions">
          <button type="submit" class="btn primary-btn">
            Save profile
          </button>
        </div>
      <% end %>
    </div>

    <!-- Right card: security -->
    <div class="profile-card">
      <h2 class="profile-section-title">Security</h2>

      <%= form_with url: update_profile_password_path,
                    method: :patch,
                    local: true,
                    class: "profile-form" do |f| %>
        <div class="profile-field-group">
          <label class="profile-label">Current password</label>
          <%= password_field_tag :current_password,
                                 nil,
                                 class: "profile-input" %>
        </div>

        <div class="profile-field-group">
          <label class="profile-label">New password</label>
          <%= password_field_tag :new_password,
                                 nil,
                                 class: "profile-input" %>
        </div>

        <div class="profile-field-group">
          <label class="profile-label">Confirm new password</label>
          <%= password_field_tag :new_password_confirmation,
                                 nil,
                                 class: "profile-input" %>
        </div>

        <div class="profile-actions">
          <button type="submit" class="btn secondary-btn">
            Update password
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const select = document.getElementById("default-title-select");
    const wrapper = document.getElementById("custom-title-wrapper");
    if (!select || !wrapper) return;

    const toggle = () => {
      if (select.value === "Other") {
        wrapper.classList.remove("is-hidden");
      } else {
        wrapper.classList.add("is-hidden");
      }
    };

    select.addEventListener("change", toggle);
    toggle();
  });
</script>
